<!DOCTYPE html><html lang="pt-BR" dir="ltr"><head><meta charset="utf-8"><title>AngularJS: Tips about Promises and $http Service – Rafaell Lycan</title><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0"> <meta name="apple-mobile-web-app-capable" content="yes"><link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon"> <meta name="description" content="A good practices guide about how to use Promises along with services (especially the $http) in AngularJS world. "><meta name="keywords" content="desenvolvedor, front end, back end, developer, php, javascript, node, laravel, angular, react, software"><meta name="author" content="Rafaell Lycan - https://rafaell-lycan.com"/><meta name="reply-to" content="sonny.webdsg@gmail"/><link rel="canonical" href="https://rafaell-lycan.com/2017/angular-tips-about-promises-http-service/"><link rel="alternate" type="application/rss+xml" href="https://feeds.feedburner.com/rafaell-lycan" title="Rafaell Lycan RSS Feed"><link rel="dns-prefetch" href="//google-analytics.com"><link rel="dns-prefetch" href="//www.google-analytics.com"><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel='dns-prefetch' href='//s2.getsmartlook.com'><link rel='dns-prefetch' href='//rec.getsmartlook.com'><link rel="preconnect" href="//google-analytics.com" crossorigin /><link rel="preconnect" href="//www.google-analytics.com" crossorigin /><link rel="preconnect" href="//fonts.googleapis.com" crossorigin /><link rel='preconnect' href='//s2.getsmartlook.com' crossorigin><link rel='preconnect' href='//rec.getsmartlook.com' crossorigin> <meta name="google-site-verification" content="x08xUXYXTQWjHPyl9M_w5VIF07UWLSi0XUTxxCSS7rQ" /><meta name="robots" content="index, follow"><meta name="HandheldFriendly" content="True" /><meta name="MobileOptimized" content="320" /><meta name="mobile-web-app-capable" content="yes"><link rel="manifest" href="/manifest.json"><link rel="icon" sizes="192x192" href="/assets/img/icon-192x192.png"><link rel="icon" sizes="144x144" href="/assets/img/icon-144x144.png"><link rel="apple-touch-icon" sizes="128x128" href="/assets/img/icon-144x144.png"><link rel="apple-touch-icon-precomposed" sizes="128x128" href="/assets/img/icon-144x144.png"> <meta property="og:locale" content="pt_BR"><meta property="og:type" content=" article "><meta property="og:title" content="AngularJS: Tips about Promises and $http Service – Rafaell Lycan"><meta property="og:url" content="https://rafaell-lycan.com/2017/angular-tips-about-promises-http-service/"><meta property="og:image" content=""><meta property="og:description" content="A good practices guide about how to use Promises along with services (especially the $http) in AngularJS world. "><meta property="og:site_name" content="Hi there, I'm Rafaell"><meta property="article:publisher" content="https://www.facebook.com/rafaell.lycan"> <meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://rafaell-lycan.com/2017/angular-tips-about-promises-http-service/"><meta name="twitter:title" content="AngularJS: Tips about Promises and $http Service – Rafaell Lycan"><meta name="twitter:image" content=""><meta name="twitter:description" content="A good practices guide about how to use Promises along with services (especially the $http) in AngularJS world. "><meta name="twitter:creator" content="@RafaellLycan"><meta property="twitter:account_id" content="50549691"> <script type="text/javascript"> if (window.location.hostname !== 'localhost') { window.smartlook||(function(d) { var o=smartlook=function(){ o.api.push(arguments)},s=d.getElementsByTagName('script')[0]; var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript'; c.charset='utf-8';c.src='//rec.getsmartlook.com/bundle.js';s.parentNode.insertBefore(c,s); })(document); smartlook('init', '71b434ed5cffc14b8ccad3c50573871bcb972ef9'); } </script><link rel="stylesheet" href="/assets/css/style.css" media="all"></head><body><main class="wrap"><header class="header"><div class="container"><div class="author"> <a href="/"> <img src="/assets/img/rafaell-lycan.jpg" alt="Rafaell Lycan profile picture" title="Back to home" class="author__avatar"> </a></div><nav class="menu-list menu-list--inline"><ul class="default-list"><li class="menu-list__item"><a href="/about">About me</a></li><li class="menu-list__item"><a href="/">Blog</a></li> </ul></nav></div></header><article class="blog-post" itemscope itemtype="https://schema.org/BlogPosting"><header class="blog-post__header"><h1 class="blog-post__title" itemprop="headline">AngularJS: Tips about Promises and $http Service</h1><div class="blog-post__meta"> <span>This post is filed under</span> <a class="h6 post-tag" href="/tags#angular">angular</a> <span> • Published</span> <time class="h6" datetime="2017-07-06T00:00:00+02:00" itemprop="datePublished">6 Jul 2017</time> <span> • Reading time 7 min </span></div><p class="hidden" itemprop="keywords"></p></header><div class="blog-post__content"><p>Hey all, everything all right?</p><p>First of all, I’d like to thank all support and those that have questions, for sure I’d like to be able to respond to everyone, or have all the answers, however, sometimes I neither have time enough or just don’t know the answer.</p><p>Currently, I’ve been reviewing a lot of Angular code lately, and received some curious emails about a problem I found many times during my reviews that it’s the unnecessary use of the <strong>deferred</strong> object to resolve or reject promises. Yes, that’s exactly what I’ll talk about today, and yes, I know it may not be the most useful thing possible, but since I had a question about it and also I always see some unnecessary code, I want to teach a simplified approach.</p><p>Another problem is always mixed <code class="highlighter-rouge">then()</code> and <code class="highlighter-rouge">catch()</code> with two callbacks in the <code class="highlighter-rouge">then()</code>, and sometimes even <code class="highlighter-rouge">success()</code> and <code class="highlighter-rouge">error()</code> in the return of the <strong>$http service</strong> . I will try to be as quickly as possible with the examples, proposing a single style that can be applied to any other promise library in the future.</p><h2 id="resolving-promises">Resolving Promises</h2><p>The code below use the <strong>$http service</strong> to make a REST call and return only the <strong>data</strong> property of the response. This is a common implementation that I usually find in AngularJS code, and I know that works, but let’s see how to improve it.</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>

  <span class="k">return</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><p>The code above could be simplified like this:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Better</span>
<span class="kd">function</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></figure><p>The <code class="highlighter-rouge">then()</code> function accepts three callback parameters: <em>successCallback, errorCallback, * and *notifyCallback</em></p><p>So, If you return a value on <strong>successCallback</strong> or <strong>errorCallback</strong>, the return will be used to resolve the <strong>promise</strong>. Yes, you don’t need to explicitly <code class="highlighter-rouge">deferred.resolve(response.data)</code> every time to solve <strong>promises</strong>, instead, you can simply return <strong>response.data</strong> in <code class="highlighter-rouge">then()</code>’s callback.</p><p>The <code class="highlighter-rouge">then()</code> function returns a new <strong>promise</strong>, so isn’t need to use <code class="highlighter-rouge">$q</code> to create a <strong>deferred</strong> object and return a <strong>promise</strong>. Just return the <strong>promise</strong> created by <code class="highlighter-rouge">then()</code>.</p><h2 id="rejecting-promises">Rejecting Promises</h2><p>What about error handling? Let’s use the example above, we can call <code class="highlighter-rouge">deferred.reject</code> as <strong>errorCallback</strong>.</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
      <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>

  <span class="k">return</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure><p>Now we can think in a simplified solution and just return something instead of reject right? But by doing so, what we return? You probably think that we could return the error as in <strong>successCallback</strong>:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">err</span><span class="p">;</span> <span class="c1">// Wrong</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></figure><p>Como disse, os valores retornados tanto de <strong>successCallback</strong> quanto de <strong>errorCallback</strong> são considerados valores resolvidos para a <strong>promise</strong>. Portanto a resposta de retorno no <strong>callback</strong> de <strong>error</strong> irá resolver a <strong>promise</strong> ao invés de rejeita-la. Mesmo se você retornar um valor falso ou não retornar nada, o valor continua sendo considerado como <strong>resolvido</strong>. Você pode utilizar uma outra forma se for necessário através do <code class="highlighter-rouge">$q.reject(err)</code>:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Better</span>
<span class="kd">function</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></figure><p>Além do <strong>errorCallback ** como segundo parâmetro a **promise</strong> tem um outro método chamado <code class="highlighter-rouge">catch()</code> para tratar as respostas de erro. Eu pessoalmente prefiro utilizar o <code class="highlighter-rouge">then()</code> e o <code class="highlighter-rouge">catch()</code> juntos ao invés de duas funções de <strong>callback</strong> dentro do <code class="highlighter-rouge">then()</code> por conta da legibilidade.</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Even Better</span>
<span class="kd">function</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></figure><p>Utilizando desta forma o <code class="highlighter-rouge">then()</code> é utilizado apenas em caso de sucesso e <code class="highlighter-rouge">catch()</code> basicamente é utilizado para os erros aplicado como se fosse o <code class="highlighter-rouge">then()</code> sem o <strong>callback</strong> de sucesso – <code class="highlighter-rouge">then(angular.noop, errorCallback)</code>.</p><p>A maior vantagem é que podemos encadear as <strong>promises</strong> retornadas através de <code class="highlighter-rouge">then()</code> e capturar qualquer erro que aconteça durante o processo em um único <code class="highlighter-rouge">catch()</code>:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">$q</span><span class="p">,</span> <span class="nx">$http</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">DataService</span><span class="p">.</span><span class="nx">validateData</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">DataService</span><span class="p">.</span><span class="nx">updateOffilineStorage</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
      <span class="k">return</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre></figure><p>Encadeando as chamadas com o serviço <code class="highlighter-rouge">DataService</code> que em alguns métodos nos retorna uma promise podemos deixar nosso código mais elegante e simples de ler e capturando quaisquer erros em um único ponto.</p><h2 id="sucesso-e-erros-no-http-service">Sucesso e Erros no $http Service</h2><p>Em versões antigas do AngularJS (1.3.x e anteriores) o <strong>$http service</strong> possui outros dois métodos adicionais que são <code class="highlighter-rouge">success()</code> e <code class="highlighter-rouge">error()</code> que são muito similares ao <code class="highlighter-rouge">then()</code>, porem existem algumas diferenças entre eles:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">})</span></code></pre></figure><p>Se você por acaso se recordou da <strong>jQuery</strong> e como as coisas eram simples naquele tempo esqueça isso, pois esses dois métodos estão obsoletos desde a versão 1.4.x basicamente pela confusão que eles introduziram.</p><p>O <strong>callback</strong> que você passa tanto para <code class="highlighter-rouge">success()</code> quanto para <code class="highlighter-rouge">error()</code> não são um objeto de resposta, mas sim os dados em si (Como na <strong>jQuery</strong>), e dentro do callback deixa de ser necessário retornar o <code class="highlighter-rouge">response.data</code> para recuperar apenas os dados da requisição. Um exemplo:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Success</span>
<span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">});</span>
  
<span class="c1">// Then</span>
<span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'...'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$log</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">});</span></code></pre></figure><p>Sim, é uma diferença boba, porem nem <code class="highlighter-rouge">success()</code> ou <code class="highlighter-rouge">error()</code> retornam uma nova <strong>promise</strong>, portanto eu recomendaria utilizar apenas <code class="highlighter-rouge">then()</code> e <code class="highlighter-rouge">catch()</code> já que existem em outras bibliotecas de <strong>promise</strong> e já foram adotados como convenção.</p><h2 id="conclusão">Conclusão</h2><p>O uso de um objeto <strong>deferred</strong> pode ser substituído por coisas mais simples:</p><ul><li>Retornar um valor especifico criando uma nova <strong>promise</strong> quando a mesma resolve.</li><li>Devolver uma <strong>promise</strong> rejeitado utilizando <code class="highlighter-rouge">$q.reject()</code> para rejeitar a promise.</li></ul><p>Prefira utilizar <code class="highlighter-rouge">catch()</code> para fornecer <strong>erroCallbacks</strong> e facilitar o encadeamento <strong>promises</strong> ao invés de dois <strong>callbacks</strong> dentro de <code class="highlighter-rouge">then()</code>. e pare de utilizar <code class="highlighter-rouge">success()</code> e <code class="highlighter-rouge">error()</code>.</p></div><section class="share"><h3>Share this post</h3><ul class="social-list"><li class="social-list__item facebook hint--bottom" data-hint="Share on Facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://rafaell-lycan.com/2017/angular-tips-about-promises-http-service/" target="share"> <span class="social-list__text">Like</span> </a></li><li class="social-list__item twitter hint--bottom" data-hint="Share on Twitter"> <a href="https://twitter.com/share?text=AngularJS: Tips about Promises and $http Service&amp;url=https://rafaell-lycan.com/2017/angular-tips-about-promises-http-service/" target="share"> <span class="social-list__text">Tweet</span> </a></li><li class="social-list__item gplus hint--bottom" data-hint="Share on Google Plus"> <a href="https://plus.google.com/share?url=https://rafaell-lycan.com/2017/angular-tips-about-promises-http-service/" target="share"> <span class="social-list__text">+1</span> </a></li></ul></section><div class="comments"><div id="disqus_thread"></div></div><script> if (window.location.hostname !== 'localhost') { var disqus_shortname = 'rafaelllycan'; var disqus_identifier = '/2017/angular-tips-about-promises-http-service'; var disqus_config = function () { this.page.url = 'https://rafaell-lycan.com/2017/angular-tips-about-promises-http-service/'; this.page.identifier = '/2017/angular-tips-about-promises-http-service'; }; (function() { var d = document, s = d.createElement('script'); s.src = '//' + disqus_shortname + '.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); s.async = true; (d.head || d.body).appendChild(s); })(); } </script></article><footer class="footer"><p> Made with <a href="https://jekyllrb.com/" target="_blank" class=" externalLink">Jekyll</a> and <span class="love">♥</span> by Rafaell Lycan.</p></footer></main><script async src="/assets/js/main.min.js"></script>  <script> !function(v,i,n,k,l,a){v.GoogleAnalyticsObject=n;v[n]||(v[n]=function(){ (v[n].q=v[n].q||[]).push(arguments)});v[n].l=+new Date;l=i.createElement(k); a=i.getElementsByTagName(k)[0];l.src='https://google-analytics.com/analytics.js'; a.parentNode.insertBefore(l,a)}(window,document,'ga','script'); ga('create', 'UA-16383035-5', 'auto'); ga('require', 'displayfeatures'); ga('send', 'pageview'); </script></body></html>
