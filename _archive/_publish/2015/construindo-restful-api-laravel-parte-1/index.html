<!DOCTYPE html><html lang="pt-BR" dir="ltr"><head><meta charset="utf-8"><title>Construindo uma API RESTful com Laravel - Parte 1 – Rafaell Lycan</title><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0"> <meta name="apple-mobile-web-app-capable" content="yes"><link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon"> <meta name="description" content="Nesta série vamos criar uma pequena aplicação focando em desenvolver uma API RESTful para armazenar vagas de emprego e ver como o Laravel nos ajudará com isso. "><meta name="keywords" content="laravel, construindo apis, api restful, laravel api, laravel cors"><meta name="author" content="Rafaell Lycan - https://rafaell-lycan.com"/><meta name="reply-to" content="sonny.webdsg@gmail"/><link rel="canonical" href="https://rafaell-lycan.com/2015/construindo-restful-api-laravel-parte-1/"><link rel="alternate" type="application/rss+xml" href="https://feeds.feedburner.com/rafaell-lycan" title="Rafaell Lycan RSS Feed"><link rel="dns-prefetch" href="//google-analytics.com"><link rel="dns-prefetch" href="//www.google-analytics.com"><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel='dns-prefetch' href='//s2.getsmartlook.com'><link rel='dns-prefetch' href='//rec.getsmartlook.com'><link rel="preconnect" href="//google-analytics.com" crossorigin /><link rel="preconnect" href="//www.google-analytics.com" crossorigin /><link rel="preconnect" href="//fonts.googleapis.com" crossorigin /><link rel='preconnect' href='//s2.getsmartlook.com' crossorigin><link rel='preconnect' href='//rec.getsmartlook.com' crossorigin> <meta name="google-site-verification" content="x08xUXYXTQWjHPyl9M_w5VIF07UWLSi0XUTxxCSS7rQ" /><meta name="robots" content="index, follow"><meta name="HandheldFriendly" content="True" /><meta name="MobileOptimized" content="320" /><meta name="mobile-web-app-capable" content="yes"><link rel="manifest" href="/manifest.json"><link rel="icon" sizes="192x192" href="/assets/img/icon-192x192.png"><link rel="icon" sizes="144x144" href="/assets/img/icon-144x144.png"><link rel="apple-touch-icon" sizes="128x128" href="/assets/img/icon-144x144.png"><link rel="apple-touch-icon-precomposed" sizes="128x128" href="/assets/img/icon-144x144.png"> <meta property="og:locale" content="pt_BR"><meta property="og:type" content=" article "><meta property="og:title" content="Construindo uma API RESTful com Laravel - Parte 1 – Rafaell Lycan"><meta property="og:url" content="https://rafaell-lycan.com/2015/construindo-restful-api-laravel-parte-1/"><meta property="og:image" content="https://rafaell-lycan.com/assets/img/posts/laravel-api.jpg"><meta property="og:description" content="Nesta série vamos criar uma pequena aplicação focando em desenvolver uma API RESTful para armazenar vagas de emprego e ver como o Laravel nos ajudará com isso. "><meta property="og:site_name" content="Hi there, I'm Rafaell"><meta property="article:publisher" content="https://www.facebook.com/rafaell.lycan"> <meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://rafaell-lycan.com/2015/construindo-restful-api-laravel-parte-1/"><meta name="twitter:title" content="Construindo uma API RESTful com Laravel - Parte 1 – Rafaell Lycan"><meta name="twitter:image" content="https://rafaell-lycan.com/assets/img/posts/laravel-api.jpg"><meta name="twitter:description" content="Nesta série vamos criar uma pequena aplicação focando em desenvolver uma API RESTful para armazenar vagas de emprego e ver como o Laravel nos ajudará com isso. "><meta name="twitter:creator" content="@RafaellLycan"><meta property="twitter:account_id" content="50549691"> <script type="text/javascript"> if (window.location.hostname !== 'localhost') { window.smartlook||(function(d) { var o=smartlook=function(){ o.api.push(arguments)},s=d.getElementsByTagName('script')[0]; var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript'; c.charset='utf-8';c.src='//rec.getsmartlook.com/bundle.js';s.parentNode.insertBefore(c,s); })(document); smartlook('init', '71b434ed5cffc14b8ccad3c50573871bcb972ef9'); } </script><link rel="stylesheet" href="/assets/css/style.css" media="all"></head><body><main class="wrap"><header class="header"><div class="container"><div class="author"> <a href="/"> <img src="/assets/img/rafaell-lycan.jpg" alt="Rafaell Lycan profile picture" title="Back to home" class="author__avatar"> </a></div><nav class="menu-list menu-list--inline"><ul class="default-list"><li class="menu-list__item"><a href="/about">About me</a></li><li class="menu-list__item"><a href="/">Blog</a></li> </ul></nav></div></header><article class="blog-post" itemscope itemtype="https://schema.org/BlogPosting"><header class="blog-post__header"><h1 class="blog-post__title" itemprop="headline">Construindo uma API RESTful com Laravel - Parte 1</h1><div class="blog-post__meta"> <span>This post is filed under</span> <a class="h6 post-tag" href="/tags#laravel">laravel</a>, <a class="h6 post-tag" href="/tags#php">php</a> <span> • Published</span> <time class="h6" datetime="2015-12-10T00:00:00+01:00" itemprop="datePublished">10 Dec 2015</time> <span> • Reading time 17 min </span></div><figure class="blog-post__banner"> <img src="/assets/img/posts/laravel-api.jpg" alt="Construindo uma API RESTful com Laravel - Parte 1" title="Construindo uma API RESTful com Laravel - Parte 1" itemprop="thumbnailUrl"></figure><p class="hidden" itemprop="keywords">laravel, construindo apis, api restful, laravel api, laravel cors</p></header><div class="blog-post__content"><p>Primeiramente, quero deixar claro que não vou me aprofundar muito em padrões de projeto nem otimizações. O foco aqui é resolver pequenos problemas que tive e que gostaria de compartilhar com vocês, mesmo que existam materiais em inglês com mais detalhamentos, etc.</p><p>Se você já entende bem os conceitos de como o Laravel funciona, como utilizar o <code class="highlighter-rouge">Route</code> de uma forma mais organizada, com <strong>grupos</strong>, <strong>middlewares</strong>, tipos de <code class="highlighter-rouge">response</code> como <strong>json</strong>, proteção contra <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a> e <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a>, talvez esse post não seja destinado a você.</p><p><strong><em>Mas sinta-se a vontade para me dar feedback de onde posso melhorar.</em></strong></p><h2 id="objetivo">Objetivo</h2><p>Construir uma API RESTful para armazenar vagas de emprego cadastradas por uma empresa. Simples não?</p><p>Vamos a um Roadmap do que irei abordar nesta série:</p><ul><li><a href="#instalao">Instalação e configuração do Laravel</a></li><li><a href="#http-e-o-restful">HTTP e RESTful</a></li><li><a href="#models-e-migrations">Models e Migrations</a></li><li>Controllers e Rotas</li><li>Middlewares</li><li>Autenticação e Sessão</li><li>Validações e tratamento de erros</li><li>Controle de cache com Redis</li></ul><p>Se der tempo <del>e coragem</del>, eu posso colocar testes também.</p><h2 id="instalação">Instalação</h2><p>Vamos utilizar o <a href="https://getcomposer.org/">Composer</a> para criar nosso novo projeto, nada de clonar o repositório nem nada do tipo.</p><figure class="highlight"><pre><code class="language-text" data-lang="text">composer create-project laravel/laravel laravel-api</code></pre></figure><p>Quando a instalação terminar, vá ate a pasta criada e abra em seu editor de preferência.</p><p>Existe uma pequena coisa que precisamos resolver antes de começarmos a desenvolver nosso serviço RESTful, e se não resolvermos isso logo após a instalação, isso vai nos empacar no meio do desenvolvimento e provavelmente não vamos achar isso legal.</p><p>Por padrão, a partir da versão 5, o Laravel usa por padrão um middleware para previnir CSRF. Porem, não estamos construindo websites, mas sim uma API, o que perde faz esse middleware perder completamente o sentido em nosso projeto.</p><p>Para remove-lo, e para fazer isso vamos até a pasta <strong>app/Http</strong> e abrir o arquivo <strong>Kernel.php</strong>. Nele, vamos remover a seguinte linha:</p><figure class="highlight"><pre><code class="language-text" data-lang="text">\App\Http\Middleware\VerifyCsrfToken::class,</code></pre></figure><p>Vamos também remover alguns arquivos inuteis como nossa view default <strong>welcome.blade.php</strong> dentro de <strong>resources/views</strong> e qualquer controller default que a app tenha criado dentro de <strong>app/Http/Controllers</strong>.</p><p>Vamos ao <strong>setup</strong> da nossa API utilizando o <strong>.env</strong>, recurso adicionado na versão 5 do framework. Vamos renomear o arquivo <code class="highlighter-rouge">.env.example</code> para apenas <code class="highlighter-rouge">.env</code>, e adicionar algumas como banco de dados:</p><figure class="highlight"><pre><code class="language-text" data-lang="text">APP_ENV=local
APP_DEBUG=true
APP_KEY=6894RPBq2sEylIP3C5XDUnEniIRwreLT

DB_HOST=localhost
DB_DATABASE=laravel
DB_USERNAME=root
DB_PASSWORD=root

CACHE_DRIVER=file
SESSION_DRIVER=file
QUEUE_DRIVER=sync

MAIL_DRIVER=smtp
MAIL_HOST=mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=null</code></pre></figure><p>’’</p><p>No caso eu apenas adicionei o usuário <strong>root</strong> do meu <strong>MySQL</strong> e a minha senha praticamente inquebravel.</p><p>O <code class="highlighter-rouge">APP_KEY</code> normalmente é gerado na instalação, mas caso algo dê errado, você pode executar o comando <code class="highlighter-rouge">php artisan key:generate</code>.</p><p>Em nosso MySQL vamos apenas precisar criar o banco de dados, todo o resto sera feito através de <a href="https://en.wikipedia.org/wiki/Data_migration">migrations</a>.</p><p>Acesse seu banco de dados e crie o database <code class="highlighter-rouge">laravel</code>:</p><figure class="highlight"><pre><code class="language-text" data-lang="text">CREATE DATABASE laravel</code></pre></figure><p>Por ultimo, mas não menos importante, em <code class="highlighter-rouge">/config/app.php</code> vamos alterar o <strong>timezone</strong> da nossa aplicação para <code class="highlighter-rouge">America/Sao_Paulo</code>. Eu particularmente não gosto de utilizar UTC na aplicação, a não ser que seja realmente necessário.</p><h2 id="http-e-o-restful">HTTP e o RESTful</h2><p>Antes de ir mais além em nível de código, vamos ver rapidamente uma abordagem sobre HTTP e RESTful, porque se vamos falar de APIs, acho válido também citar a base da coisa.</p><h4 id="porque-restrestful">Porque REST/RESTful?</h4><p>REST é uma maneira simples de realizar e permitir interações entre sistemas independentes que ganhou força nos últimos anos inspirado pelo HTTP.</p><p>Nossa <em>app</em> utiliza o conteito <strong>RESTful</strong> sob o protocólo <strong>HTTP</strong>, ou seja, utilizando <em>URLs</em>, <em>verbos HTTP</em> e <em>status code</em>.</p><h4 id="http">HTTP</h4><p>HTTP é o protocolo que nos permite enviar e receber documentos através da web. No conceito do HTTP temos o <strong>servidor</strong> e o <strong>cliente</strong> que em linhas gerais se comunicam através do protocolo através de mensagens de texto, ou bits de texto mesmo que no corpo da mensagem possa existir algum tipo de mídia, tudo isso é transferido através de trocas de mensagens utilizando bits de texto.</p><h4 id="urls">URLS</h4><p>São as responsáveis por serem os identificadores para obter algum recurso, assim como páginas na web, como a página de contato, artista, entre muitas outras que um site possa ter.</p><p>Seguindo esse pensamento, cada URL é um tipo de recurso, vamos considerar a nossa aplicação com algumas URLs simples:</p><figure class="highlight"><pre><code class="language-text" data-lang="text">/jobs               // Returns all jobs
/jobs/add           // Render a form to add a new job
/job/123            // Return the job with ID 123
/companies/123      // Returns the company with ID 123
/companies/123/edit  // Render a form to edit the company with ID 123</code></pre></figure><p>No padrão <em>RESTful</em> utilizamos por convenção nossas URLs (também chamados de <strong><em>endpoint</em></strong>) sempre no plural, indiferente do retorno ser um único registro por conta do ID passado como segundo parâmetro. Recursos são identificadores únicos.</p><p><strong><em>Mas e se eu precisar de uma action diferente? Salvar, Criar, Atualizar, Deletar?</em></strong></p><p>Simples meu caro, para isso utilizamos os verbos HTTP.</p><h4 id="verbos-http">Verbos HTTP</h4><p>A cada requisição realizada, é utilizado um tipo de verbo HTTP no cabeçalho da requisição. Exemplo:</p><figure class="highlight"><pre><code class="language-text" data-lang="text">GET     /jobs           // Returns all jobs
DELETE  /job/123        // Delete the job with ID 123
POST    /companies      // Create a new company through post data
PUT     /companies/123  // Update a company with ID 123</code></pre></figure><p>Se você cria formulários com HTML, você já deve estar familiarizado com os dois métodos mais importantes do verbo HTTP: <strong>GET</strong> e <strong>POST</strong>. Mas além deles, temos outros métodos também disponíveis que são muito importantes para criarmos uma aplicação <em>RESTful</em> como <em>GET</em>, <em>POST</em>, <em>PUT</em> e <em>DELETE</em>. Ainda existem outros como o <em>OPTIONS</em> e <em>HEAD</em>, mas não quero ir muito a fundo neste assunto.</p><ul><li><strong>GET</strong> é o método HTTP mais simples. Utilizado toda vez que você clica em um link ou digita uma URL no browser. Uma requisição <em>GET</em> não deve modificar nenhum recurso em seu sistema, ou seja, deve apenas recuperar informações; <br /> <strong>Ex:</strong> Listagem das vagas. <code class="highlighter-rouge">GET /api/jobs</code> <br /></li><li><strong>POST</strong> é utilizado quando precisamos processar algo no servidor, adicionar informações a um recurso ou criar um novo recurso. Quando enviamos um formulário de cadastro para o servidor, que envia um corpo em seu request a uma URL especifica; <br /> <strong>Ex:</strong> Criação de um Job ou uma Empresa. <code class="highlighter-rouge">POST /api/jobs</code> <br /></li><li><strong>PUT</strong> é utilizado quando queremos criar ou atualizar um recurso existente através de um <em>endpoint</em> especifico. A grande diferença entre <em>PUT</em> e <em>POST</em> é que além utilizarem <em>endpoints</em> diferentes, o <em>POST</em> utiliza uma URL onde vai ser tratada a informação e o <em>PUT</em> utiliza o <em>endpoint</em> em que a informação será armazenada/atualizada em sí; <br /> <strong>Ex:</strong> Atualizar dados da Empresa ou Job. <code class="highlighter-rouge">PUT /api/jobs/1</code> <br /></li><li><strong>DELETE</strong> é utilizado quando queremos remover algum recurso passado por uma URL especifica; <br /> <strong>Ex:</strong> Deletar um Job. <code class="highlighter-rouge">DELETE /api/jobs/1</code></li></ul><h4 id="status-code">Status Code</h4><p>Eu particularmente acho essa parte como uma das mais importantes e também uma das mais discutidas.</p><p><strong>Status Code / Response Codes</strong> é a forma padrão de informar ao cliente sobre o resultado de uma requisição feita ao servidor. Essas informações ficam contidas nas <strong>headers</strong> das requisições HTTP que por padrão carregam alguns tipos de dados como o <strong>status code</strong>, <strong>encode</strong>, <strong>content type</strong>, etc.</p><p>Alguns desenvolvedores utilizam convenção de status 200 (OK) para alguns erros de requisição como um registro não encontrado e coisas do tipo, já outros preferem utilizar erros na faixa dos 400 ou 500 para facilitar o tratamento no cliente, mas isso varia muito.</p><p>O servidor deve retornar o status mais apropriado para cada tipo de requisição. Dessa forma o cliente consegue tratar mais facilmente erros entre outras coisas. O erro mais familitar que a maioria conhece é o 404 (Not Found), ainda assim existem vários outros que podem ser muito úteis para se utilizar em seu serviço.</p><p>Alguns dos <strong>status code</strong> mais utilizados em uma arquitetura REST:</p><h4 id="200-ok">200 OK</h4><p>Indica que uma requisição foi feita com sucesso.</p><h4 id="201-created">201 Created</h4><p>Indica que uma requisição foi feita com sucesso e que um recurso foi criado. Normalmente utilizamos esse padrão de resposta para <strong>POST</strong> e <strong>PUT</strong>.</p><h4 id="400-bad-request">400 Bad Request</h4><p>Infica que uma requisição não possuí um formato especifico. Normalmente utilizada quando alguma validação de dados não passa, ou quando esta faltando algum dado ou até mesmo um formato errado. Muito comum utilizar como erro de retorno para <strong>POST</strong> e <strong>PUT</strong>.</p><h4 id="401-unauthorized">401 Unauthorized</h4><p>Indica que o recurso ou <em>endpoint</em> precisa de um requisição autenticada antes de proseguir.</p><h4 id="404-not-found">404 Not Found</h4><p>Indica que o recurso da requisição não existe. Normalmente utilizado quando um <strong>endpoint</strong> não corresponde com nenhuma rota registrada na aplicação.</p><h4 id="405-method-not-allowed">405 Method Not Allowed</h4><p>Indica que o método HTTP utilizado não esta disponível para aquele <em>endpoint</em>.</p><h4 id="409-conflict">409 Conflict</h4><p>Indica que um conflito ocorreu durante a requisição. Por exemplo, isso poderia ocorrer quando você utiliza <strong>PUT</strong> para atualizar o mesmo registro com dados duplicado, pode não ser um exemplo muito bom, mas não tenho nada melhor em mente.</p><h4 id="422-unprocessable-entity">422 Unprocessable Entity</h4><p>Indica que a request foi realizada e entendida pelo servidor, porem não foi possível proceguir devido a erros no formato/parâmetros informados. Por exemplo, o erro pode ser lançado caso você espere um XML como parâmetro mas ao invés disso o cliente envia um JSON, ou em um caso mais simplificado poreriam ser valores obrigatórios em um JSON que não correspondem com um modelo/validação.</p><h4 id="500-internal-server-error">500 Internal Server Error</h4><p>Indica uma falha do lado servidor, normalmente utilizamos quando algo inesperado acontece do lado servidor.</p><p>Em geral, devemos assumir que as respostas HTTP devem ser utilizadas para melhorar o tipo de resposta da nossa aplicação, mas sempre visando o bom senso, tente utilizar da forma correta principalmente quanto aos códigos de erro.</p><p>Aos que gostam de cachorros, existe um site que mostra todos os HTTP Status Code <a href="http://httpstatusdogs.com/">bem aqui</a>.</p><h2 id="models-e-migrations">Models e Migrations</h2><p>Nossa App será bem simples, vai consistir em duas models: <strong>Company</strong> que sera referente as empresas(usuários) cadastrados em nossa app, e <strong>Job</strong> referente as vagas cadastradas.</p><p>Primeiramente vamos criar nosso model <strong>Company</strong>:</p><figure class="highlight"><pre><code class="language-text" data-lang="text">php artisan make:model Company
php artisan make:model Job</code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Company</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">//
</span><span class="p">}</span></code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Job</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="c1">//
</span><span class="p">}</span></code></pre></figure><p>Certo, agora vem a parte onde vamos utilizar <strong>migrations</strong>, que funcionam como controle de versão para nosso banco de dados quando precisamos criar/modificar tabelas ou suas propriedades.</p><p>Para saber mais sobre <strong>migrations</strong> no Laravel, acesse <a href="http://laravel.com/docs/5.1/migrations">este link</a>.</p><p>Agora vamos pensar em nossos <strong>schemas</strong>. Um Job pertence a uma empresa (Company), ou seja, a empresa pode ter N jobs, logo temos uma relação <strong>1:N</strong>.</p><p>Quanto aos tipos de dados, vamos ir pelo básico:</p><ul><li><strong>Company</strong> tem um <em>nome</em>, <em>email</em> para login/login, url para o <em>website</em>, url para o <em>logo</em> e uma <em>senha</em>;</li><li><strong>Job</strong> possui um <em>titulo</em>, uma <em>descrição</em>, um <em>local</em> de trabalho, se é permitido trabalhar remotamente e o <em>tipo</em> do job.</li></ul><p>Além é claro que o <strong>Job</strong> esta vinculado a uma <strong>Company</strong>, então baseado nisso vamos criar nossas <em>migrations</em> começando pela nossa tabela <strong>Companies</strong>;</p><figure class="highlight"><pre><code class="language-text" data-lang="text">php artisan make:migration create_companies_table --create=companies</code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Schema\Blueprint</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Migrations\Migration</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CreateCompaniesTable</span> <span class="k">extends</span> <span class="nx">Migration</span>
<span class="p">{</span>
    <span class="sd">/**
     * Run the migrations.
     *
     * @return void
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">Schema</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="s1">'companies'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">increments</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="mi">60</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">'website'</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">'logo'</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">timestamps</span><span class="p">();</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">softDeletes</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Reverse the migrations.
     *
     * @return void
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">down</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">Schema</span><span class="o">::</span><span class="na">drop</span><span class="p">(</span><span class="s1">'companies'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Vamos a explicação básica:</p><ul><li>Criamos uma migration através de nosso CLI <strong>artisan</strong> para a tabela <strong>companies</strong></li><li>Adicionamos um <strong>Schema</strong> base restringindo o tamanho de algumas colunas como <em>name</em>, <em>email</em> e <em>password</em>;</li><li>Informamos que a coluna <em>email</em> sera do tipo <code class="highlighter-rouge">UNIQUE</code>, para não termos logins duplicados em nosso sistema;</li><li>Também incluimos <strong>timestamps</strong> que nos geram dois <strong>timestamp</strong> <code class="highlighter-rouge">create_at</code> e <code class="highlighter-rouge">update_at</code>, bem como <strong>soft delete</strong> que nos gera um <strong>timestamp</strong> <code class="highlighter-rouge">deleted_at</code>.</li></ul><p>Para aqueles que ainda não estão familiarizados com o processo de <em>migragions</em> e o <a href="http://laravel.com/docs/5.1/eloquent">Eloquent</a>, ele utiliza essas 3 colunas com o principio de sempre ter uma referencia sobre os dados criados, atualizados e removidos, que no caso não são removidos de fato quando utilizamos <code class="highlighter-rouge">softDeletes()</code>, o <strong>Eloquent</strong> modifica a query caso essa coluna exista na tabela utilizando a clausula <strong>WHERE</strong>, algo como <code class="highlighter-rouge">WHERE delete_at IS NULL</code> na hora de trazer o resultado.</p><p>Vamos agora criar a migration para nossa tabela <strong>Jobs</strong>, a qual tera uma referencia para a tabela <strong>Companies</strong> através de uma <strong>foreign key</strong>.</p><figure class="highlight"><pre><code class="language-text" data-lang="text">php artisan make:migration create_jobs_table --create=jobs</code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Schema\Blueprint</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Migrations\Migration</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CreateJobsTable</span> <span class="k">extends</span> <span class="nx">Migration</span>
<span class="p">{</span>
    <span class="sd">/**
     * Run the migrations.
     *
     * @return void
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">up</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">Schema</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="s1">'jobs'</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Blueprint</span> <span class="nv">$table</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">increments</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">'title'</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">longText</span><span class="p">(</span><span class="s1">'description'</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">(</span><span class="s1">'local'</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">enum</span><span class="p">(</span><span class="s1">'remote'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'yes'</span><span class="p">,</span> <span class="s1">'no'</span><span class="p">]);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">integer</span><span class="p">(</span><span class="s1">'type'</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">integer</span><span class="p">(</span><span class="s1">'company_id'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">unsigned</span><span class="p">();</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">foreign</span><span class="p">(</span><span class="s1">'company_id'</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">references</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">on</span><span class="p">(</span><span class="s1">'companies'</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">onDelete</span><span class="p">(</span><span class="s1">'cascade'</span><span class="p">);</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">timestamps</span><span class="p">();</span>
            <span class="nv">$table</span><span class="o">-&gt;</span><span class="na">softDeletes</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="sd">/**
     * Reverse the migrations.
     *
     * @return void
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">down</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">Schema</span><span class="o">::</span><span class="na">drop</span><span class="p">(</span><span class="s1">'jobs'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Rapida explicação:</p><ul><li>Migration através do <strong>artisan CLI</strong>;</li><li>Adicionamos um <strong>Schema</strong> simples utilizando tipos como <code class="highlighter-rouge">INT</code>, <code class="highlighter-rouge">VARCHAR</code>, <code class="highlighter-rouge">ENUM</code>, <code class="highlighter-rouge">LONGTEXT</code>, etc;</li><li>Também adicionamos <strong>timestamps</strong> e <strong>softDeletes</strong> pelas mesmas razões da tabela posterior;</li><li>Adicionamos uma <strong>foreign key</strong> <code class="highlighter-rouge">company_id</code> com a regra <strong>unsigned</strong> para não manter um relacionamento restrito ao criar/modificar as tabelas;</li><li>Informamos a referencia a tabela <strong>Companies</strong> e utilizamos o <strong>delete cascade</strong> quando o ID referênte for deletado.</li></ul><p>Chega de explicações chatas, vamos apenas atualizar nossas models:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Company</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$fillable</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'email'</span><span class="p">,</span> <span class="s1">'website'</span><span class="p">,</span> <span class="s1">'logo'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">];</span>

    <span class="k">protected</span> <span class="nv">$hidden</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'password'</span><span class="p">];</span>

    <span class="k">protected</span> <span class="nv">$dates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'deleted_at'</span><span class="p">];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">jobs</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="s1">'App\Job'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Job</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$fillable</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'title'</span><span class="p">,</span> <span class="s1">'description'</span><span class="p">,</span> <span class="s1">'local'</span><span class="p">,</span> <span class="s1">'remote'</span><span class="p">,</span> <span class="s1">'type'</span><span class="p">,</span> <span class="s1">'company_id'</span><span class="p">];</span>

    <span class="k">protected</span> <span class="nv">$dates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'deleted_at'</span><span class="p">];</span>

    <span class="k">function</span> <span class="nf">company</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="s1">'App\User'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Pronto, agora com nossas <em>models</em> atualizadas, definimos <strong>white lists</strong> através do atributo <code class="highlighter-rouge">$fillable</code>, utilizamos o relacionamento através <code class="highlighter-rouge">belongsTo</code> e <code class="highlighter-rouge">hasMany</code> em métodos específicos para nos trazer a listagem da relação dos models, além de deixamos explicito que estamos utilizando <strong>soft delete</strong> através do atributo <code class="highlighter-rouge">$dates</code>.</p><p>A nível de teste, você pode criar um simples <strong>seed</strong> para inserir os primeiros dados da nossa <em>app</em>:</p><figure class="highlight"><pre><code class="language-php" data-lang="php">// CompaniesSeed.php
<span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Seeder</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CompaniesSeed</span> <span class="k">extends</span> <span class="nx">Seeder</span>
<span class="p">{</span>
    <span class="sd">/**
     * Run the database seeds.
     *
     * @return void
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">run</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">App\Company</span><span class="o">::</span><span class="na">create</span><span class="p">([</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nx">str_random</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nx">str_random</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="s1">'@gmail.com'</span><span class="p">,</span>
            <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="nx">bcrypt</span><span class="p">(</span><span class="s1">'secret'</span><span class="p">),</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php">// JobsSeed.php
<span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Seeder</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobsSeed</span> <span class="k">extends</span> <span class="nx">Seeder</span>
<span class="p">{</span>
    <span class="sd">/**
     * Run the database seeds.
     *
     * @return void
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">run</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">App\Job</span><span class="o">::</span><span class="na">create</span><span class="p">([</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nx">str_random</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
            <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nx">str_random</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
            <span class="s1">'local'</span> <span class="o">=&gt;</span> <span class="s1">'São Paulo / SP'</span><span class="p">,</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nx">str_random</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
            <span class="s1">'remote'</span> <span class="o">=&gt;</span> <span class="s1">'no'</span><span class="p">,</span>
            <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s1">'company_id'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php">// DatabaseSeeder.php
<span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Seeder</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DatabaseSeeder</span> <span class="k">extends</span> <span class="nx">Seeder</span>
<span class="p">{</span>
    <span class="sd">/**
     * Run the database seeds.
     *
     * @return void
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">run</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nx">Model</span><span class="o">::</span><span class="na">unguard</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">call</span><span class="p">(</span><span class="nx">CompaniesSeed</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">call</span><span class="p">(</span><span class="nx">JobsSeed</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>

        <span class="nx">Model</span><span class="o">::</span><span class="na">reguard</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Você pode inclusive testar via o <a href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">REPL</a> do Laravel através do comando <code class="highlighter-rouge">php artisan tinker</code>.</p><figure class="highlight"><pre><code class="language-text" data-lang="text">var_dump( App\Company::all() );

$company = App\Company::find(1);
var_dump($company-&gt;jobs);</code></pre></figure><p>No proximo artigo desta série, vamos abordar os <em>Controllers</em>, <em>Rotas</em>, tipos e mensagens de <em>erro</em> e retornar valores em JSON.</p></div><section class="share"><h3>Share this post</h3><ul class="social-list"><li class="social-list__item facebook hint--bottom" data-hint="Share on Facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://rafaell-lycan.com/2015/construindo-restful-api-laravel-parte-1/" target="share"> <span class="social-list__text">Like</span> </a></li><li class="social-list__item twitter hint--bottom" data-hint="Share on Twitter"> <a href="https://twitter.com/share?text=Construindo uma API RESTful com Laravel - Parte 1&amp;url=https://rafaell-lycan.com/2015/construindo-restful-api-laravel-parte-1/" target="share"> <span class="social-list__text">Tweet</span> </a></li><li class="social-list__item gplus hint--bottom" data-hint="Share on Google Plus"> <a href="https://plus.google.com/share?url=https://rafaell-lycan.com/2015/construindo-restful-api-laravel-parte-1/" target="share"> <span class="social-list__text">+1</span> </a></li></ul></section><section class="related"><h3 class="related__title">Referências</h3><ul class="default-list"><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://vimeo.com/17785736" title="Teach a Dog to REST" target="_blank"> <span itemprop="name">Teach a Dog to REST</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="http://laravel.com/docs/5.1/migrations" title="Database - Migrations" target="_blank"> <span itemprop="name">Database - Migrations</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="http://laravel.com/docs/5.1/eloquent" title="Eloquent - Getting Started" target="_blank"> <span itemprop="name">Eloquent - Getting Started</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="http://laravel.com/docs/5.1/eloquent-relationships" title="Eloquent - Relationships" target="_blank"> <span itemprop="name">Eloquent - Relationships</span> </a></li></ul></section><div class="comments"><div id="disqus_thread"></div></div><script> if (window.location.hostname !== 'localhost') { var disqus_shortname = 'rafaelllycan'; var disqus_identifier = '/2015/construindo-restful-api-laravel-parte-1'; var disqus_config = function () { this.page.url = 'https://rafaell-lycan.com/2015/construindo-restful-api-laravel-parte-1/'; this.page.identifier = '/2015/construindo-restful-api-laravel-parte-1'; }; (function() { var d = document, s = d.createElement('script'); s.src = '//' + disqus_shortname + '.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); s.async = true; (d.head || d.body).appendChild(s); })(); } </script></article><footer class="footer"><p> Made with <a href="https://jekyllrb.com/" target="_blank" class=" externalLink">Jekyll</a> and <span class="love">♥</span> by Rafaell Lycan.</p></footer></main><script async src="/assets/js/main.min.js"></script>  <script> !function(v,i,n,k,l,a){v.GoogleAnalyticsObject=n;v[n]||(v[n]=function(){ (v[n].q=v[n].q||[]).push(arguments)});v[n].l=+new Date;l=i.createElement(k); a=i.getElementsByTagName(k)[0];l.src='https://google-analytics.com/analytics.js'; a.parentNode.insertBefore(l,a)}(window,document,'ga','script'); ga('create', 'UA-16383035-5', 'auto'); ga('require', 'displayfeatures'); ga('send', 'pageview'); </script></body></html>
