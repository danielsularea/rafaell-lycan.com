<!DOCTYPE html><html lang="pt-BR" dir="ltr"><head><meta charset="utf-8"><title>Autenticação com Tokens em uma aplicação AngularJS – Rafaell Lycan</title><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0"> <meta name="apple-mobile-web-app-capable" content="yes"><link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon"> <meta name="description" content="Neste artigo vamos ver como desenvolver um exeplo de autenticação utilizando AngularJS Json Web Token. "><meta name="keywords" content="angular, jwt, auth, js"><meta name="author" content="Rafaell Lycan - https://rafaell-lycan.com"/><meta name="reply-to" content="sonny.webdsg@gmail"/><link rel="canonical" href="https://rafaell-lycan.com/2016/autenticacao-jwt-angular-app/"><link rel="alternate" type="application/rss+xml" href="https://feeds.feedburner.com/rafaell-lycan" title="Rafaell Lycan RSS Feed"><link rel="dns-prefetch" href="//google-analytics.com"><link rel="dns-prefetch" href="//www.google-analytics.com"><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel='dns-prefetch' href='//s2.getsmartlook.com'><link rel='dns-prefetch' href='//rec.getsmartlook.com'><link rel="preconnect" href="//google-analytics.com" crossorigin /><link rel="preconnect" href="//www.google-analytics.com" crossorigin /><link rel="preconnect" href="//fonts.googleapis.com" crossorigin /><link rel='preconnect' href='//s2.getsmartlook.com' crossorigin><link rel='preconnect' href='//rec.getsmartlook.com' crossorigin> <meta name="google-site-verification" content="x08xUXYXTQWjHPyl9M_w5VIF07UWLSi0XUTxxCSS7rQ" /><meta name="robots" content="index, follow"><meta name="HandheldFriendly" content="True" /><meta name="MobileOptimized" content="320" /><meta name="mobile-web-app-capable" content="yes"><link rel="manifest" href="/manifest.json"><link rel="icon" sizes="192x192" href="/assets/img/icon-192x192.png"><link rel="icon" sizes="144x144" href="/assets/img/icon-144x144.png"><link rel="apple-touch-icon" sizes="128x128" href="/assets/img/icon-144x144.png"><link rel="apple-touch-icon-precomposed" sizes="128x128" href="/assets/img/icon-144x144.png"> <meta property="og:locale" content="pt_BR"><meta property="og:type" content=" article "><meta property="og:title" content="Autenticação com Tokens em uma aplicação AngularJS – Rafaell Lycan"><meta property="og:url" content="https://rafaell-lycan.com/2016/autenticacao-jwt-angular-app/"><meta property="og:image" content=""><meta property="og:description" content="Neste artigo vamos ver como desenvolver um exeplo de autenticação utilizando AngularJS Json Web Token. "><meta property="og:site_name" content="Hi there, I'm Rafaell"><meta property="article:publisher" content="https://www.facebook.com/rafaell.lycan"> <meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://rafaell-lycan.com/2016/autenticacao-jwt-angular-app/"><meta name="twitter:title" content="Autenticação com Tokens em uma aplicação AngularJS – Rafaell Lycan"><meta name="twitter:image" content=""><meta name="twitter:description" content="Neste artigo vamos ver como desenvolver um exeplo de autenticação utilizando AngularJS Json Web Token. "><meta name="twitter:creator" content="@RafaellLycan"><meta property="twitter:account_id" content="50549691"> <script type="text/javascript"> if (window.location.hostname !== 'localhost') { window.smartlook||(function(d) { var o=smartlook=function(){ o.api.push(arguments)},s=d.getElementsByTagName('script')[0]; var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript'; c.charset='utf-8';c.src='//rec.getsmartlook.com/bundle.js';s.parentNode.insertBefore(c,s); })(document); smartlook('init', '71b434ed5cffc14b8ccad3c50573871bcb972ef9'); } </script><link rel="stylesheet" href="/assets/css/style.css" media="all"></head><body><main class="wrap"><header class="header"><div class="container"><div class="author"> <a href="/"> <img src="/assets/img/rafaell-lycan.jpg" alt="Rafaell Lycan profile picture" title="Back to home" class="author__avatar"> </a></div><nav class="menu-list menu-list--inline"><ul class="default-list"><li class="menu-list__item"><a href="/about">About me</a></li><li class="menu-list__item"><a href="/">Blog</a></li> </ul></nav></div></header><article class="blog-post" itemscope itemtype="https://schema.org/BlogPosting"><header class="blog-post__header"><h1 class="blog-post__title" itemprop="headline">Autenticação com Tokens em uma aplicação AngularJS</h1><div class="blog-post__meta"> <span>This post is filed under</span> <a class="h6 post-tag" href="/tags#development">development</a>, <a class="h6 post-tag" href="/tags#angular">angular</a> <span> • Published</span> <time class="h6" datetime="2016-05-29T00:00:00+02:00" itemprop="datePublished">29 May 2016</time> <span> • Reading time 11 min </span></div><p class="hidden" itemprop="keywords">angular, jwt, auth, js</p></header><div class="blog-post__content"><p>Primeiramente vamos a pergunta que não quer calar: <strong>você usa tokens?</strong></p><p>Se você quer pular a teoria e ir direto para o código, sinta-se livre e veja <a href="#angular-app">usar tokens em um SPA Angular</a>.</p><p>Então todo mundo já utilizou token algumas vezes na vida. Como? Sabe aqueles arquivos marotos que ficam em nossos navegadores chamados <strong><a href="https://en.wikipedia.org/wiki/HTTP_cookie">cookies</a></strong>? Então, a cada vez que utilizamos sessão do servidor, a aplicação grava um número composto da sessão e expiração em um cookie. Sim, você usa token, talvez apenas não se deu conta disso.</p><p>Tokens são uma forma de se identificar com a aplicação, nada mais que isso.</p><p>Num mundo virtual cada token representa uma sessão/identificação. Um token pode conter N informações como nível de acesso, data de expiração e outras coisas não muito recomendadas como ID do usuário normalmente encriptado com 128 bits (128-bit <a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES</a>).</p><p>Quando falamos de tokens, temos que ter uma maneira simples de criar um padrão de tokens inteligentes, e toda essa magia por traz disso é composta por algumas especificações do Json Object Signing and Encryption (JOSE) que é um conjunto de definições dos padrões para a criação de tokens inteligentes (<a href="https://tools.ietf.org/html/rfc7519">RFC 7519</a>).</p><p>JOSE divide a ordem lógica de criação e composição de tokens em 5 padrões: JWT, JWA, JWS, JWK e JWE.</p><h2 id="jwt">JWT</h2><p>Json Web Token (JWT) é um padrão (<a href="https://tools.ietf.org/html/rfc7165">RFC 7165</a>) que define como transmitir de forma segura objetos JSON compactos entre aplicações. Neste artigo vamos nos focar nele.</p><p>Para criarmos um JWT, precisamos entender que ele é composto por 3 elementos:</p><h4 id="headers">Headers</h4><p><strong>Headers</strong> são objetos JSON que normalmente definem duas partes: O <strong>tipo do token</strong> (typ) que é <strong>JWT</strong>, e o <strong>algorítimo (alg) de encriptação</strong> que será utilizado, como HMAC SHA256 ou RSA;</p><p>Exemplo:</p><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nt">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HS256"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"JWT"</span><span class="w">
</span><span class="p">}</span></code></pre></figure><h4 id="payload-claims">Payload (Claims)</h4><p><strong>Payloads</strong> são objetos JSON que contem os chamados <strong>claims</strong>, que pode definição são os atributos sobre a entidade tratada (normalmente o usuário). Existem 3 tipos de claims em payloads:</p><ul><li>Reserved claims: São atributos não obrigatórios (mas recomendados) que podem ser um conjunto de informações úteis e interoperáveis normalmente utilizados por protocolos de segurança em várias APIs. <em>Ex: <strong>iss</strong>(issuer), <strong>exp</strong>(expiration), <strong>sub</strong>(subject), etc.</em></li><li>Public claims: São atributos que definem o uso do JWT e informações úteis para a aplicação.</li><li>Private claims: São atributos definidos especialmente para compartilhar informações entre aplicações</li></ul><p>Exemplo:</p><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nt">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.github.com"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1300819380</span><span class="p">,</span><span class="w">
  </span><span class="nt">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rafaell-lycan"</span><span class="p">,</span><span class="w">
  </span><span class="nt">"admin"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="p">}</span></code></pre></figure><h4 id="signature">Signature</h4><p>Onde a magia acontece, é a terceira e ultima parte do nosso JWT feita a partir do hash (Base64Url) do header e do payload e uma <strong>chave</strong> definida em nossa aplicação e assinar isso.</p><p>Vamos a um exemplo utilizando o algoritimo HMAC SHA256:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">encodedString</span> <span class="o">=</span> <span class="nx">base64UrlEncode</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"."</span> <span class="o">+</span> <span class="nx">base64UrlEncode</span><span class="p">(</span><span class="nx">payload</span><span class="p">);</span>

<span class="nx">HMACSHA256</span><span class="p">(</span><span class="nx">encodedString</span><span class="p">,</span> <span class="s1">'secret'</span><span class="p">);</span></code></pre></figure><p>Isso ira gerar um token com essa estrutura:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL2FwaS5naXRodWIuY29tIiwiZXhwIjoxMzAwODE5MzgwLCJ1c2VyIjoicmFmYWVsbC1seWNhbiIsImFkbWluIjp0cnVlLCJpYXQiOjE0NjQxOTQzNTh9.CcXOdvwL1baDNzhEjds9u59oHVrqG97hj9oVdZMzpaI</code></pre></figure><p>Perceba que é uma string dividida em <strong>3 partes</strong> separados por <code class="highlighter-rouge">.</code>, sendo elas os respectivos hashs dos headers, payload e signature.</p><p>Atualmente o <a href="https://auth0.com/">Auth0</a> é o melhor lugar para tirar informações sobre como criar e testar seus tokens. Você também pode utilizar o <a href="https://jwt.io/">JWT Debugger</a> para verificar se a assinatura é válida.</p><p><strong>Tudo muito lindo e legal, mas como isso funciona na prática?</strong></p><p>Imagine que sua Aplicação possui 2 clientes: SPA e Mobile. Nós utilizaremos o JWT para <strong>autenticar</strong> o usuário a acessar certas partes da nossa aplicação, mas para isso ele precisa logar em nosso sistema que retornar um JWT a ser armazenado na aplicação (LocalStorage/SQLite) ao invés de utilizar o modo tradicional através de cookies e sessão.</p><p>Sempre que for necessário acessar recursos protegidos, o cliente deve enviar o JWT através do <strong>Authorization</strong> na header utilizando a flag <strong>Bearer</strong>.</p><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="err">Authorization:</span><span class="w"> </span><span class="err">Bearer</span><span class="w"> </span><span class="err">&lt;token&gt;</span></code></pre></figure><p>Este é um exemplo de autenticação <strong>stateless</strong>, que é uma forma de proteger rotas onde uma vez que o usuário o JWT definido, ele pode acessar recursos protegidos. Uma boa ideia é colocar alguns dados no payload que irão reduzir o acesso ao DB sem necessidade. Essa também é uma forma de permitir serviços comunicarem-se entre si. E o melhor, não importa de qual domínio sua aplicação esta sendo acessada, pois podemos facilmente contornar esse problema utilizando <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a>, o que já não é possível através de cookies a não ser que você faça uma gambiarra com <code class="highlighter-rouge">postMessage()</code> que não é uma coisa muito bonita de se fazer.</p><p>O diagrama a baixo mostra o processo: <img src="https://cdn.auth0.com/content/jwt/jwt-diagram.png" alt="Comunicação via JWT" /></p><p>Agora que você já sabe o que é um JWT, então podemos continuar para a autenticação no Angular.</p><h2 id="angular-app">Angular App</h2><p>No lado cliente, nossa aplicação Angular precisa enviar dados de autorização para nossa API no cabeçalho a cada requisição HTTP.</p><p>Essa é uma alteração comum em uma aplicação MEAN Stack, pois como disse anteriormente cookies não são a melhor maneira de criarmos e utilizarmos tokens.</p><p>Eu vou dividir o exemplo em 3 partes:</p><ol><li>Auth Service</li><li>HTTP Interceptor</li><li>Secured Routes</li></ol><p>Como é um exemplo simples, eu vou deixar claro que nos códigos a seguir estou utilizando o <a href="https://github.com/gsklee/ngStorage">ngStorage</a> e <a href="https://docs.angularjs.org/api/ngRoute">ngRoute</a>.</p><h4 id="auth-service">Auth Service</h4><p>Bom, o <code class="highlighter-rouge">AuthService</code> será o encarregado por fazer login/logout e armazenar o token do usuário.</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'app'</span><span class="p">,</span> <span class="p">[])</span>
  <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">'AuthService'</span><span class="p">,</span> <span class="nx">AuthService</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">AuthService</span> <span class="p">(</span><span class="nx">$http</span><span class="p">,</span> <span class="nx">$localStorage</span><span class="p">,</span> <span class="nx">$q</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">getToken</span> <span class="p">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">$localStorage</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="na">setToken</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$localStorage</span><span class="p">.</span><span class="nx">token</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="na">signin</span> <span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'api/signin'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">signup</span> <span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">$http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'api/signup'</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">logout</span> <span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="nx">$localStorage</span><span class="p">.</span><span class="nx">token</span><span class="p">;</span>
      <span class="nx">$q</span><span class="p">.</span><span class="nx">when</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></figure><p>Sim, este exemplo de serviço esta longe de ser um dos melhores, já que ele faz muita coisa como gerenciar as rotas e gerenciar o token da aplicação. Uma boa refatoração seria isolar isso em dois serviços.</p><p>Explicando brevemente, temos <strong>signin</strong> onde passamos <em>username</em> e <em>password</em> e como retorno temos o token caso sucesso, e <strong>signup</strong> onde passamos os dados para cadastro e no fim também temos o token caso sucesso. <strong>logout</strong> apenas vamos deletar o token da aplicação e o <strong>retorno é uma promise</strong>/<code class="highlighter-rouge">$q.when()</code>, o qual será <em>utilizada para um possível redirect</em> e <strong>get/set</strong> para utilizarmos o token.</p><h4 id="http-interceptor">HTTP Interceptor</h4><p>Tendo em mente que nosso <code class="highlighter-rouge">AuthService</code> já esta pronto, agora precisamos injeta-lo em nosso serviço HTTP. Lembrando que podemos ter vários interceptores em nossa aplicação.</p><p>Existem 2 tipos de interceptors: <strong>Request</strong> e <strong>Response</strong>.</p><p>Ambos são funções, com a principal diferença que toda <strong>request</strong> recebe um objeto <strong>config</strong> como parametro default, o qual configura toda requisição realizada, enquanto toda <strong>response</strong> recebe o objeto de response padrão da API.</p><p>É muito comum tratar vulnerabilidade dependendo do contexto e conteúdo que você tem na sua aplicação.</p><p>Tanto a <strong>request</strong> quanto a <strong>response</strong> podem sofrer algum tipo de falha/rejeição durante a ação, então também temos dois handlers para tratarmos os erros de requisição.</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'app'</span><span class="p">,</span> <span class="p">[])</span>
  <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">'AuthInterceptor'</span><span class="p">,</span> <span class="nx">AuthInterceptor</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">$httpProvider</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$httpProvider</span><span class="p">.</span><span class="nx">interceptors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'AuthInterceptor'</span><span class="p">);</span>
  <span class="p">});</span>

<span class="kd">function</span> <span class="nx">AuthInterceptor</span> <span class="p">(</span><span class="nx">$location</span><span class="p">,</span> <span class="nx">AuthService</span><span class="p">,</span> <span class="nx">$q</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">request</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">||</span> <span class="p">{};</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">AuthService</span><span class="p">.</span><span class="nx">getToken</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'Bearer '</span> <span class="o">+</span> <span class="nx">AuthService</span><span class="p">.</span><span class="nx">getToken</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">config</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="na">responseError</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">401</span> <span class="o">||</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">403</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">'/signin'</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">$q</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Em resumo nós colocamos um <code class="highlighter-rouge">AuthInterceptor</code> utilizando o <code class="highlighter-rouge">$httpProvider</code> onde configuramos as headers da aplicação para caso exista um token em nosso <code class="highlighter-rouge">AuthService</code>, o mesmo será adicionado junto a flag <strong>Bearer</strong> no momento da <strong>request</strong>, e adicionamos um <strong>handler de error</strong> em nosso <strong>response</strong> para caso o status da requisição retorne 401 ou 403 nós redirecionamos o usuário para a tela de login e caso contrário nós passsamos o erro adiante através de <code class="highlighter-rouge">$q.reject()</code>.</p><h4 id="secured-routes">Secured Routes</h4><p>Por padrão como disse anteriormente sua app deveria ser stateless, mas como o mundo não é perfeito nem de longe, eu quero compartilhar uma abordagem para validar rotas verificando o mínimo possível.</p><p>A primeira coisa a ser feita é adicionar um parâmetro simples nas propriedades da rota para verificar se a rota precisa ser autenticada ou não:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">$routeProvider</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="s1">'/rota-segura'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'/template.html'</span><span class="p">,</span>
  <span class="na">controller</span><span class="p">:</span> <span class="s1">'mainController'</span><span class="p">,</span>
  <span class="na">controllerAs</span><span class="p">:</span> <span class="s1">'vm'</span><span class="p">,</span>
  <span class="na">authorize</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">});</span></code></pre></figure><p>Feito isso, a cada mudança de rota, precisamos agora verificar se existe a propriedade <code class="highlighter-rouge">authorize</code> na rota destino, o que faremos escutando o evento <code class="highlighter-rouge">$routeChangeStart</code> do <strong>ngRoute</strong>.</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s1">'app'</span><span class="p">,</span> <span class="p">[])</span>
  <span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">$rootScope</span><span class="p">,</span> <span class="nx">$location</span><span class="p">,</span> <span class="nx">AuthService</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$on</span><span class="p">(</span><span class="s1">'$routeChangeStart'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">authorize</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">AuthService</span><span class="p">.</span><span class="nx">getToken</span><span class="p">())</span> <span class="p">{</span>
          <span class="cm">/* Ugly way
          event.preventDefault();
          $location.path('/login');
          ========================== */</span>

          <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$evalAsync</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">$location</span><span class="p">.</span><span class="nx">path</span><span class="p">(</span><span class="s1">'/signin'</span><span class="p">);</span>
          <span class="p">})</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">});</span>

  <span class="p">});</span></code></pre></figure><p>Neste exemplo deixamos claro que além de verificar se a rota possui a propriedade <code class="highlighter-rouge">authorize</code>, também verifico uma informação adicional, nesse caso eu usei o <code class="highlighter-rouge">getToken()</code> mas você pode utilizar o que fizer sentido na sua aplicação. Talvez um nível de usuário ou algo do tipo. Quanto a forma de cancelar o evento, existem duas formas de se fazer a mesma coisa. A primeira que é mais simples é cancelar o evento através de <code class="highlighter-rouge">event.preventDefault()</code> e redirecionar o usuário. Uma forma mais elegante seria utilizar o <code class="highlighter-rouge">$evalAsync</code> que é um método existente nos escopos que em uma cadeia de eventos assincronos, ele tem prioridade sobre as outras, ou seja, ele precisa rodar para o evento vigente continuar, o que nesse caso cancela o evento default da rota e atualiza o escopo redirecionando o usuário.</p><h2 id="nota">Nota</h2><p>Sei que estou um tanto quanto ausente nos posts, principalmente na série Laravel, mas prometo colocar mais conteúdo assim que possível.</p><p>Na verdade este post só saiu por conta de ser uma coisa que fui motivado a fazer pelo <strong>Fabio Santos</strong>, o qual me mandou um email perguntando exatamente sobre isso, então durante algumas horas no meu fim de semana eu li um pouco mais sobre <strong>JOSE</strong> e as RFC’s afim de melhor meu embasamento teórico e escrever algo de qualidade.</p><p>Acho justo escrever coisas com qualidade, e não apenas escrever por escrever.</p><p>Em algumas semanas eu vou ter mais tempo para escrever, pois estarei de férias da pós, assim termino os posts de Laravel e outros dois sobre NodeJS.</p><p>Dúvidas? Podem colocar nos comentários abaixo que assim que der eu respondo.</p></div><section class="share"><h3>Share this post</h3><ul class="social-list"><li class="social-list__item facebook hint--bottom" data-hint="Share on Facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://rafaell-lycan.com/2016/autenticacao-jwt-angular-app/" target="share"> <span class="social-list__text">Like</span> </a></li><li class="social-list__item twitter hint--bottom" data-hint="Share on Twitter"> <a href="https://twitter.com/share?text=Autenticação com Tokens em uma aplicação AngularJS&amp;url=https://rafaell-lycan.com/2016/autenticacao-jwt-angular-app/" target="share"> <span class="social-list__text">Tweet</span> </a></li><li class="social-list__item gplus hint--bottom" data-hint="Share on Google Plus"> <a href="https://plus.google.com/share?url=https://rafaell-lycan.com/2016/autenticacao-jwt-angular-app/" target="share"> <span class="social-list__text">+1</span> </a></li></ul></section><section class="related"><h3 class="related__title">Referências</h3><ul class="default-list"><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://jwt.io/" title="JWT.IO" target="_blank"> <span itemprop="name">JWT.IO</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://www.youtube.com/watch?v=trCEGixJu34" title="Death to Cookies, Long Live JSON Web Tokens" target="_blank"> <span itemprop="name">Death to Cookies, Long Live JSON Web Tokens</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://docs.angularjs.org/api/ng/service/$http#interceptors" title="Angular $HTTP Interceptors" target="_blank"> <span itemprop="name">Angular $HTTP Interceptors</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="http://www.bennadel.com/blog/2777-monitoring-http-activity-with-http-interceptors-in-angularjs.htm" title="Monitoring $http Activity With $http Interceptors In AngularJS" target="_blank"> <span itemprop="name">Monitoring $http Activity With $http Interceptors In AngularJS</span> </a></li></ul></section><div class="comments"><div id="disqus_thread"></div></div><script> if (window.location.hostname !== 'localhost') { var disqus_shortname = 'rafaelllycan'; var disqus_identifier = '/2016/autenticacao-jwt-angular-app'; var disqus_config = function () { this.page.url = 'https://rafaell-lycan.com/2016/autenticacao-jwt-angular-app/'; this.page.identifier = '/2016/autenticacao-jwt-angular-app'; }; (function() { var d = document, s = d.createElement('script'); s.src = '//' + disqus_shortname + '.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); s.async = true; (d.head || d.body).appendChild(s); })(); } </script></article><footer class="footer"><p> Made with <a href="https://jekyllrb.com/" target="_blank" class=" externalLink">Jekyll</a> and <span class="love">♥</span> by Rafaell Lycan.</p></footer></main><script async src="/assets/js/main.min.js"></script>  <script> !function(v,i,n,k,l,a){v.GoogleAnalyticsObject=n;v[n]||(v[n]=function(){ (v[n].q=v[n].q||[]).push(arguments)});v[n].l=+new Date;l=i.createElement(k); a=i.getElementsByTagName(k)[0];l.src='https://google-analytics.com/analytics.js'; a.parentNode.insertBefore(l,a)}(window,document,'ga','script'); ga('create', 'UA-16383035-5', 'auto'); ga('require', 'displayfeatures'); ga('send', 'pageview'); </script></body></html>
