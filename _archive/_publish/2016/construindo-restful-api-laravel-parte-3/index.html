<!DOCTYPE html><html lang="pt-BR" dir="ltr"><head><meta charset="utf-8"><title>Construindo uma API RESTful com Laravel - Parte 3 – Rafaell Lycan</title><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0"> <meta name="apple-mobile-web-app-capable" content="yes"><link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon"> <meta name="description" content="No artigo anterior da série criamos nossas rotas e finalizamos nosso CRUD, mas enfim a jornada chega ao fim. Vamos trabalhar com validações, autenticação e tratamento de erros. "><meta name="keywords" content="laravel, construindo apis, api restful, laravel api, laravel cors"><meta name="author" content="Rafaell Lycan - https://rafaell-lycan.com"/><meta name="reply-to" content="sonny.webdsg@gmail"/><link rel="canonical" href="https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-3/"><link rel="alternate" type="application/rss+xml" href="https://feeds.feedburner.com/rafaell-lycan" title="Rafaell Lycan RSS Feed"><link rel="dns-prefetch" href="//google-analytics.com"><link rel="dns-prefetch" href="//www.google-analytics.com"><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel='dns-prefetch' href='//s2.getsmartlook.com'><link rel='dns-prefetch' href='//rec.getsmartlook.com'><link rel="preconnect" href="//google-analytics.com" crossorigin /><link rel="preconnect" href="//www.google-analytics.com" crossorigin /><link rel="preconnect" href="//fonts.googleapis.com" crossorigin /><link rel='preconnect' href='//s2.getsmartlook.com' crossorigin><link rel='preconnect' href='//rec.getsmartlook.com' crossorigin> <meta name="google-site-verification" content="x08xUXYXTQWjHPyl9M_w5VIF07UWLSi0XUTxxCSS7rQ" /><meta name="robots" content="index, follow"><meta name="HandheldFriendly" content="True" /><meta name="MobileOptimized" content="320" /><meta name="mobile-web-app-capable" content="yes"><link rel="manifest" href="/manifest.json"><link rel="icon" sizes="192x192" href="/assets/img/icon-192x192.png"><link rel="icon" sizes="144x144" href="/assets/img/icon-144x144.png"><link rel="apple-touch-icon" sizes="128x128" href="/assets/img/icon-144x144.png"><link rel="apple-touch-icon-precomposed" sizes="128x128" href="/assets/img/icon-144x144.png"> <meta property="og:locale" content="pt_BR"><meta property="og:type" content=" article "><meta property="og:title" content="Construindo uma API RESTful com Laravel - Parte 3 – Rafaell Lycan"><meta property="og:url" content="https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-3/"><meta property="og:image" content="https://rafaell-lycan.com/assets/img/posts/laravel-api.jpg"><meta property="og:description" content="No artigo anterior da série criamos nossas rotas e finalizamos nosso CRUD, mas enfim a jornada chega ao fim. Vamos trabalhar com validações, autenticação e tratamento de erros. "><meta property="og:site_name" content="Hi there, I'm Rafaell"><meta property="article:publisher" content="https://www.facebook.com/rafaell.lycan"> <meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-3/"><meta name="twitter:title" content="Construindo uma API RESTful com Laravel - Parte 3 – Rafaell Lycan"><meta name="twitter:image" content="https://rafaell-lycan.com/assets/img/posts/laravel-api.jpg"><meta name="twitter:description" content="No artigo anterior da série criamos nossas rotas e finalizamos nosso CRUD, mas enfim a jornada chega ao fim. Vamos trabalhar com validações, autenticação e tratamento de erros. "><meta name="twitter:creator" content="@RafaellLycan"><meta property="twitter:account_id" content="50549691"> <script type="text/javascript"> if (window.location.hostname !== 'localhost') { window.smartlook||(function(d) { var o=smartlook=function(){ o.api.push(arguments)},s=d.getElementsByTagName('script')[0]; var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript'; c.charset='utf-8';c.src='//rec.getsmartlook.com/bundle.js';s.parentNode.insertBefore(c,s); })(document); smartlook('init', '71b434ed5cffc14b8ccad3c50573871bcb972ef9'); } </script><link rel="stylesheet" href="/assets/css/style.css" media="all"></head><body><main class="wrap"><header class="header"><div class="container"><div class="author"> <a href="/"> <img src="/assets/img/rafaell-lycan.jpg" alt="Rafaell Lycan profile picture" title="Back to home" class="author__avatar"> </a></div><nav class="menu-list menu-list--inline"><ul class="default-list"><li class="menu-list__item"><a href="/about">About me</a></li><li class="menu-list__item"><a href="/">Blog</a></li> </ul></nav></div></header><article class="blog-post" itemscope itemtype="https://schema.org/BlogPosting"><header class="blog-post__header"><h1 class="blog-post__title" itemprop="headline">Construindo uma API RESTful com Laravel - Parte 3</h1><div class="blog-post__meta"> <span>This post is filed under</span> <a class="h6 post-tag" href="/tags#laravel">laravel</a>, <a class="h6 post-tag" href="/tags#php">php</a> <span> • Published</span> <time class="h6" datetime="2016-08-16T00:00:00+02:00" itemprop="datePublished">16 Aug 2016</time> <span> • Reading time 23 min </span></div><figure class="blog-post__banner"> <img src="/assets/img/posts/laravel-api.jpg" alt="Construindo uma API RESTful com Laravel - Parte 3" title="Construindo uma API RESTful com Laravel - Parte 3" itemprop="thumbnailUrl"></figure><p class="hidden" itemprop="keywords">laravel, construindo apis, api restful, laravel api, laravel cors</p></header><div class="blog-post__content"><p><a href="2016/construindo-restful-api-laravel-parte-2/">No artigo anterior da série</a> criamos nossas rotas e adicionamos uma verificação básica de autenticação através de <strong>middlewares</strong>, mas enfim a jornada chega ao fim. Vamos trabalhar com <strong>validações</strong>, <strong>autenticação</strong> e tratamento de erros.</p><p>Nesta parte vamos tocar os seguintes tópicos do roadmap:</p><ul><li>Autenticação e Sessão</li><li>Validações e tratamento de erros</li><li><del>Controle de cache com Redis</del></li></ul><h2 id="autenticação-e-sessão">Autenticação e Sessão</h2><p>Quando falamos de autenticação e sessão isso pode ser um assunto um tanto trivial para alguns, principalmente se pensarmos em aplicações web classicas, através de <strong>forms de login</strong> e sessão utilizando <strong>cookies</strong>. Mas desta vez estamos falando de uma API, a qual deveria ser <strong>stateless</strong> e com toda comunidação (request/response) simplificada utilizando JSON.</p><p>Nós vamos utilizar <strong>JWT</strong> <em>(Json Web Token)</em> para a comunicação em nossas rotas privadas, o qual irá conter as informações básicas do usuário que esta pedindo a requisição. Eu não vou explicar em detalhes o que é um JWT, mas você pode ler sobre isso neste artigo sobre <em><a href="2016/autenticacao-jwt-angular-app/">Autenticação com Tokens em uma aplicação AngularJS</a></em> e entender os 3 elementos que formam um JWT válido.</p><p>Agora que estamos alinhados,vamos instalar o pacote <code class="highlighter-rouge">jwt-auth</code> em nosso <code class="highlighter-rouge">composer.json</code>. Atualize o bloco <code class="highlighter-rouge">require</code> incluindo o novo pacote:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>

<span class="s2">"require"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"php"</span><span class="o">:</span> <span class="s2">"&gt;=5.5.9"</span><span class="p">,</span>
    <span class="s2">"laravel/framework"</span><span class="o">:</span> <span class="s2">"5.1.*"</span><span class="p">,</span>
    <span class="s2">"tymon/jwt-auth"</span><span class="o">:</span> <span class="s2">"0.5.*"</span>
<span class="p">},</span></code></pre></figure><p>Em seguida, vamos atualizar nossos pacotes rodando o comando abaixo:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">composer update</code></pre></figure><p>Agora precisamos atualizar nosso array de providers no arquivo <code class="highlighter-rouge">config/app.php</code>. Procure pelo aray <code class="highlighter-rouge">providers</code> localizado na <strong>linha 111</strong> e adicione a seguinte linha:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>

<span class="nx">Tymon\JWTAuth\Providers\JWTAuthServiceProvider</span><span class="o">::</span><span class="na">class</span></code></pre></figure><p>Também é necessário adicionar os facedes do pacote <code class="highlighter-rouge">jwt-auth</code> no mesmo arquivo. Procure logo abaixo um array chamado <code class="highlighter-rouge">aliases</code> e adicione essas duas linhas:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>

<span class="s1">'JWTAuth'</span>   <span class="o">=&gt;</span> <span class="nx">Tymon\JWTAuthFacades\JWTAuth</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
<span class="s1">'JWTFactory'</span> <span class="o">=&gt;</span> <span class="nx">Tymon\JWTAuthFacades\JWTFactory</span><span class="o">::</span><span class="na">class</span></code></pre></figure><p>Por fim, precisamos publicar os arquivos de configuração deste novo pacote. Fazemos isso rodando o comando abaixo:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">php artisan vendor:publish --provider<span class="o">=</span><span class="s2">"Tymon</span><span class="se">\J</span><span class="s2">WTAuth</span><span class="se">\P</span><span class="s2">roviders</span><span class="se">\J</span><span class="s2">WTAuthServiceProvider"</span></code></pre></figure><p>Pronto! Foi criado o arquivo <code class="highlighter-rouge">config/jwt.php</code> que contem as configurações default do <code class="highlighter-rouge">jwt-auth</code>. Vamos gerar uma chave secreta para encriptar/decriptar nossos tokens através do comando abaixo:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">php artisan jwt:generate</code></pre></figure><p>Isso irá gerar um novo valor em <code class="highlighter-rouge">secret</code> onde antes se encontrava <code class="highlighter-rouge">"changeme"</code> anteriormente. Também precisamos alterar o arquivo model do usuário que por default esta como <code class="highlighter-rouge">App\User</code>, e em nosso caso precisamos altera-lo para <code class="highlighter-rouge">App\Company</code>.</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">&lt;?php
<span class="c"># config/jwt.php</span>
...

<span class="s1">'user'</span> <span class="o">=</span>&gt; <span class="s1">'App\Company'</span>,</code></pre></figure><p>Agora já podemos trabalhar com o pacote <code class="highlighter-rouge">jwt-auth</code> e com isso já podemos definir alguns pontos básicos da nossa aplicação como a autenticação em si. Com isso vamos criar um novo controller chamado <code class="highlighter-rouge">AuthController</code> só que desta vez não queremos um <strong>resource controller</strong>, então utilizamos a flag <code class="highlighter-rouge">--plain</code> no final do comando para cria-lo em branco:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">php artisan make:controller AuthController --plain</code></pre></figure><p>Feito isso, vamos adicionar um novo <em>endpoint</em> em nosso grupo prefixado com <code class="highlighter-rouge">api</code> em nosso arquivo de rotas:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/routes.php
</span><span class="o">...</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">'auth/login'</span><span class="p">,</span> <span class="s1">'AuthController@authenticate'</span><span class="p">);</span></code></pre></figure><p>Agora sabemos que o <em>endpoint</em> <code class="highlighter-rouge">/api/auth/login</code> através do verbo <code class="highlighter-rouge">POST</code> irá utilizar o método <code class="highlighter-rouge">authenticate</code> do nosso controller, então vamos desenvolve-lo:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Controllers/AuthController.php
</span>
<span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Company</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">JWTAuth</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Hash</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AuthController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Get only email and password from request
</span>      <span class="nv">$credentials</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">only</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>

      <span class="c1">// Get user by email
</span>      <span class="nv">$company</span> <span class="o">=</span> <span class="nx">Company</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="nv">$credentials</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>

      <span class="c1">// Validate Company
</span>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$company</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
          <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="s1">'Invalid credentials'</span>
        <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Validate Password
</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Hash</span><span class="o">::</span><span class="na">check</span><span class="p">(</span><span class="nv">$credentials</span><span class="p">[</span><span class="s1">'password'</span><span class="p">],</span> <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
            <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="s1">'Invalid credentials'</span>
          <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Generate Token
</span>      <span class="nv">$token</span> <span class="o">=</span> <span class="nx">JWTAuth</span><span class="o">::</span><span class="na">fromUser</span><span class="p">(</span><span class="nv">$company</span><span class="p">);</span>

      <span class="c1">// Get expiration time
</span>      <span class="nv">$objectToken</span> <span class="o">=</span> <span class="nx">JWTAuth</span><span class="o">::</span><span class="na">setToken</span><span class="p">(</span><span class="nv">$token</span><span class="p">);</span>
      <span class="nv">$expiration</span> <span class="o">=</span> <span class="nx">JWTAuth</span><span class="o">::</span><span class="na">decode</span><span class="p">(</span><span class="nv">$objectToken</span><span class="o">-&gt;</span><span class="na">getToken</span><span class="p">())</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'exp'</span><span class="p">);</span>

      <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
        <span class="s1">'access_token'</span> <span class="o">=&gt;</span> <span class="nv">$token</span><span class="p">,</span>
        <span class="s1">'token_type'</span> <span class="o">=&gt;</span> <span class="s1">'bearer'</span><span class="p">,</span>
        <span class="s1">'expires_in'</span> <span class="o">=&gt;</span> <span class="nx">JWTAuth</span><span class="o">::</span><span class="na">decode</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'exp'</span><span class="p">)</span>
      <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>O código acima é bem simples, mas mesmo com os comentários vamos entender o que esta acontecendo passo a passo:</p><ol><li>Pegamos da nossa requisição apenas <code class="highlighter-rouge">email</code> e <code class="highlighter-rouge">password</code>;</li><li>Procuramos pela primeira ocorrência no banco de dados onde a empresa tenha o mesmo email;</li><li>Verificamos se a empresa existe. Caso <code class="highlighter-rouge">null</code> enviamos um *erro** <code class="highlighter-rouge">401</code>;</li><li>Verificamos se o <code class="highlighter-rouge">password</code> bate com o <strong>Hash</strong> que temos gravado no banco de dados. Caso contrário enviamos um *erro** <code class="highlighter-rouge">401</code>;</li><li>Geramos o token com o facede <code class="highlighter-rouge">JWTAuth</code> através do método <code class="highlighter-rouge">fromUser</code>;</li><li>A partir do token gerado, pegamos a expiração no formato <strong>timestamp</strong> <del>através de mágia negra</del>;</li><li>Retormamo nosso um <strong>JSON</strong> contendo o token e outros valores como a expiração e o tipo do token.</li></ol><p>Você deve ter percebido queutilizamos o método <code class="highlighter-rouge">fromUser</code> com um objeto do tipo <code class="highlighter-rouge">Company</code> certo? É por isso que fizemos aquela alteração no arquivo de configuração, mas também reparou que este código ainda esta falho pois não verificamos os dois parâmetros de entrada necessários <em>(<code class="highlighter-rouge">email</code> e <code class="highlighter-rouge">password</code>)</em> e ainda geramos um <strong>timestamp</strong> apenas para exibição na resposta.</p><p>Você realmente não precisa seguir este padrão de resposta que eu coloquei, eu simplesmente segui o padrão do <a href="http://oauth.net/2/">OAuth 2.0</a> baseado na <a href="https://tools.ietf.org/html/rfc6749">RFC 6749</a>, mas nada te impede de retornar apenas o token.</p><div class="center"><p><img src="/assets/img/posts/laravel-api-postman-autenticate.png" alt="Laravel Postman POST Authenticate" /></p></div><p>Agora já conseguimos criar nossos tokens, mas e quanto a recupera-los e intercepta-los em nossos requests? Primeiramente eu gostaria de informar que o pacote que escolhemos já resolve esse problema para nós através dos middlewares <code class="highlighter-rouge">jwt.auth</code> e <code class="highlighter-rouge">jwt.refresh</code>, porem vamos precisar configurar nossa model <code class="highlighter-rouge">Company</code> para suportar as implementações do driver de <code class="highlighter-rouge">Auth</code> e modificar o arquivo de configuração em <code class="highlighter-rouge">config/auth.php</code> para utilizar a classe <code class="highlighter-rouge">Company</code> por padrão ao invés de <code class="highlighter-rouge">User</code>:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># config/auth.php
</span><span class="o">...</span>

<span class="c1">// Original
</span>    <span class="s1">'model'</span> <span class="o">=&gt;</span> <span class="nx">App\User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>

    <span class="s1">'table'</span> <span class="o">=&gt;</span> <span class="s1">'users'</span><span class="p">,</span>

<span class="c1">// Updated
</span>    <span class="s1">'model'</span> <span class="o">=&gt;</span> <span class="nx">App\Company</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>

    <span class="s1">'table'</span> <span class="o">=&gt;</span> <span class="s1">'companies'</span><span class="p">,</span>
<span class="o">...</span></code></pre></figure><p>Agora vamos adicionar nossos middlewares:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Kernel.php
</span><span class="o">...</span>

<span class="k">protected</span> <span class="nv">$routeMiddleware</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'auth'</span> <span class="o">=&gt;</span> <span class="nx">\App\Http\Middleware\Authenticate</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="s1">'auth.basic'</span> <span class="o">=&gt;</span> <span class="nx">\Illuminate\Auth\Middleware\AuthenticateWithBasicAuth</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="s1">'guest'</span> <span class="o">=&gt;</span> <span class="nx">\App\Http\Middleware\RedirectIfAuthenticated</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="s1">'jwt.auth'</span> <span class="o">=&gt;</span> <span class="nx">\Tymon\JWTAuth\Middleware\GetUserFromToken</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="s1">'jwt.refresh'</span> <span class="o">=&gt;</span> <span class="nx">\TymonJWTAuth\Middleware\RefreshToken</span><span class="o">::</span><span class="na">class</span>
<span class="p">];</span>
<span class="o">...</span></code></pre></figure><p>Para evitarmos erros na hora de verificar os tokens, também precisamos <strong>implementar algumas interfaces</strong> em nossa classe <code class="highlighter-rouge">Company</code> e utilizar algumas <strong>traits</strong> que vai ficar desta forma:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Company.php
</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Auth\Authenticatable</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Auth\Passwords\CanResetPassword</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Contracts\Auth\Authenticatable</span> <span class="k">as</span> <span class="nx">AuthenticatableContract</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Contracts\Auth\CanResetPassword</span> <span class="k">as</span> <span class="nx">CanResetPasswordContract</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">Company</span> <span class="k">extends</span> <span class="nx">Model</span> <span class="k">implements</span> <span class="nx">AuthenticatableContract</span><span class="p">,</span> <span class="nx">CanResetPasswordContract</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">Authenticatable</span><span class="p">,</span> <span class="nx">CanResetPassword</span><span class="p">;</span>
<span class="o">...</span>
<span class="p">}</span></code></pre></figure><p>Agora vamos substituir nosso middleware <code class="highlighter-rouge">auth</code> por <code class="highlighter-rouge">jwt.auth</code> em ambos os controllers e pronto, já temos nossa implementação feita.</p><p>Agora falta muito pouco, pois com o token já conseguimos pegar o usuário o que vai nos permitir realizar alguns tratamentos em nossa aplicação.</p><p>Você pode testar a autenticação das rotas de duas formas, primeiramente adicionando <code class="highlighter-rouge">authorization</code> em sua header de requisição:</p><figure class="highlight"><pre><code class="language-text" data-lang="text">Authorization: Bearer {token}</code></pre></figure><p>Ou simplesmente adicionar uma query string seguida pelo token no parâmetro <code class="highlighter-rouge">token</code>:</p><figure class="highlight"><pre><code class="language-text" data-lang="text">http://localhost:8080/api/jobs?token={token}</code></pre></figure><p>Um aviso aos usuários de <strong>Apache</strong>, ele discarta a header <code class="highlighter-rouge">Authorization</code> em todas as requests, dessa forma você será forçado a reescrever a regra de configuração:</p><figure class="highlight"><pre><code class="language-text" data-lang="text">RewriteEngine On
RewriteCond %{HTTP:Authorization} ^(.*)
RewriteRule .* - [e=HTTP_AUTHORIZATION:%1]</code></pre></figure><h2 id="validações-e-tratamento-de-erros">Validações e tratamento de erros</h2><p>É claro que em questão de segurança e domínio ainda estamos muito longe de algo aceitável, ainda precisamos de validações na criação e atualização de nossos recursos, identificar quem é a empresa que esta criando um novo job ao invés de simplesmente passar o <code class="highlighter-rouge">id</code> e outros pequenos tratamentos.</p><p>Uma das coisas que eu descobri depois de um ano utilizando Laravel, assim que virou para a versão 5 foi a facilidade de customizar tudo e utilizar como injeção de dependência.</p><p>Primeiramente você precisa notar que tanto em <code class="highlighter-rouge">store</code> quanto <code class="highlighter-rouge">update</code> utilizamos como injeção o objeto <code class="highlighter-rouge">Request</code>, então o que vamos fazer é criar um tipo de request com validações em nossas estradas, e é claro que vamos utilizar o <strong>artisan</strong> para isso.</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">php artisan make:request StoreCompanyRequest

php artisan make:request UpdateCompanyRequest

php artisan make:request JobRequest

php artisan make:request AuthenticateRequest</code></pre></figure><p>Sim você leu corretamente, com isso já podemos adicionar regras customizadas para nossas entradas. Esses arquivos foram criados em <code class="highlighter-rouge">app/Http/Request/</code>, e com isso já podemos respirar aliviados adicionando nossas validações e dormir em paz a noite. :)</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Requests/AuthenticateRequest.php
</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">AuthenticateRequest</span> <span class="k">extends</span> <span class="nx">Request</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">authorize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">rules</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
            <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Controllers/AuthController.php
</span>
<span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Http\Requests\AuthenticateRequest</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AuthController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">AuthenticateRequest</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Em tese isso já resolve nosso problema, porem como nossas chamas são Ajax o retorno é sempre 200 seja para sucesso ou erro, o que implica ao exibir as mensagem de erro pois essa é uma forma de <a href="https://laravel.com/docs/5.2/validation#form-request-validation">validar erros de formulário</a> onde conseguimos retornar mensagens de erro para o front, mas infelizmente não funciona com AJAX.</p><h4 id="validando-models-e-sessão">Validando models e sessão</h4><p>É possível através de um código ligeiramente simples adicionar validadores a nossa aplicação. Veja um exemplo:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>

<span class="c1">// Validator Method
</span><span class="k">protected</span> <span class="k">function</span> <span class="nf">companyValidator</span><span class="p">(</span><span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">(),</span> <span class="p">[</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'required|max:100'</span><span class="p">,</span>
        <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'required|email|unique:companies'</span>
    <span class="p">]);</span>

    <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$validator</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">companyValidator</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
          <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Validation Failed'</span><span class="p">,</span>
          <span class="s1">'errors'</span>        <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span>
      <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
  <span class="p">}</span>
<span class="o">...</span>
<span class="p">}</span></code></pre></figure><p>Com esse pequeno trecho de código já é possível criar uma validação com regras simples em <code class="highlighter-rouge">name</code> e <code class="highlighter-rouge">email</code> e prevenir que eu tente cadastrar algo sem todos os dados necessários.</p><p>Imagine que podemos tratar isso em nossas requisições <code class="highlighter-rouge">POST</code> e <code class="highlighter-rouge">PUT</code> previnindo assim registros em branco, e quando um erro ocorre, retornamos um JSON formatado com todos os erros e utilizando o status HTTP <code class="highlighter-rouge">422</code> como o retorno a seguir:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="s2">"message"</span><span class="err">:</span> <span class="s2">"Validation Failed"</span><span class="p">,</span>
  <span class="s2">"errors"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"name"</span><span class="err">:</span> <span class="p">[</span>
      <span class="s2">"The name field is required."</span>
    <span class="p">],</span>
    <span class="s2">"email"</span><span class="err">:</span> <span class="p">[</span>
      <span class="s2">"The email field is required."</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Gostou? Pois é o Laravel possui esses pequenos serviços como o <code class="highlighter-rouge">Validator</code>, que pode nos ajudar em coisas simples e pontuais. Poderiamos até mesmo realizar validações diretamente em nossas models mas nesse caso vamos expor nossas validações diretamente em nossos controllers, mesmo eu pensando que essa não é a maneira ideal.</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Controllers/AuthController.php
</span>
<span class="k">use</span> <span class="nx">Validator</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">AuthController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>

<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO: authenticate JWT
</span>      <span class="nv">$credentials</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">only</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>

      <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$credentials</span><span class="p">,</span> <span class="p">[</span>
          <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
          <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span>
      <span class="p">]);</span>

      <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
              <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Invalid credentials'</span><span class="p">,</span>
              <span class="s1">'errors'</span>        <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span>
          <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
      <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Pronto, já validamos a entrada de autenticação da API. É claro que isso vai depender muito do que queremos validar exatamente, mas para nosso exemplo serve perfeitamente bem.</p><p>Agora vamos validar o cadastro e a atualização em <code class="highlighter-rouge">CompaniesController</code> em <code class="highlighter-rouge">store</code>, <code class="highlighter-rouge">update</code> e <code class="highlighter-rouge">delete</code>:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Controllers/CompaniesController.php
</span>
<span class="k">use</span> <span class="nx">Validator</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">CompaniesController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>

<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">'jwt.auth'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'except'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'show'</span><span class="p">,</span> <span class="s1">'store'</span><span class="p">]]);</span>
    <span class="p">}</span>
<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'required|max:100'</span><span class="p">,</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'required|email|unique:companies'</span><span class="p">,</span>
            <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
        <span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Validation Failed'</span><span class="p">,</span>
                <span class="s1">'errors'</span>    <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span>
            <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$company</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Company</span><span class="p">();</span>
        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">only</span><span class="p">(</span><span class="s1">'password'</span><span class="p">)[</span><span class="s2">"password"</span><span class="p">];</span>
        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nx">Hash</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$company</span><span class="p">,</span> <span class="mi">201</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$company</span> <span class="o">=</span> <span class="nx">Company</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

        <span class="c1">// Verify if $company exists
</span>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$company</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Remove email from $data if it doesn't change
</span>        <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">email</span> <span class="o">==</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span> <span class="p">{</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'max:100'</span><span class="p">,</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'email|unique:companies'</span><span class="p">,</span>
        <span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Validation Failed'</span><span class="p">,</span>
                <span class="s1">'errors'</span>    <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span>
            <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">());</span>

        <span class="c1">// Verify if exists a new password on the request
</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nx">Hash</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$company</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$company</span> <span class="o">=</span> <span class="nx">Company</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$company</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">\Auth</span><span class="o">::</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">!=</span> <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'You haven\'t permission to delete this entry'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$company</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(),</span> <span class="mi">204</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>O método <code class="highlighter-rouge">store</code> é bem simples, parecido com o exemplo anterior onde deixamos as 3 entradas como <code class="highlighter-rouge">required</code> e adicionamos uma validação extra em email onde informamos que deve conter o formato de email e também que ele deve ser único, baseado em nossa base em <code class="highlighter-rouge">companies</code>.</p><p>Já o método <code class="highlighter-rouge">update</code> tivemos que adicionar algumas regras extras como por exemplo verificar se o <code class="highlighter-rouge">email</code> é novo ou é o mesmo que já temos em nosso objeto <code class="highlighter-rouge">$company</code> para evitarmos receber o erro que o email já existe na base e continuar validando emails únicos. Além disso também fazemos a verificação se existe um novo <code class="highlighter-rouge">password</code> na request, e caso existir criamos um <code class="highlighter-rouge">Hash</code> a partir dele e finalmente atualizamos nosso registro.</p><p>Você também deve ter reparado que deixamos o método <code class="highlighter-rouge">store</code> fora da validação do middleware <code class="highlighter-rouge">jwt.auth</code>, isso acontece porque não vamos estar logados quando criarmos uma empresa, já que precisamos de uma para se logar no sistema.</p><p>Enquanto isso temos a mesma validação de identidade em <code class="highlighter-rouge">update</code> e <code class="highlighter-rouge">delete</code> que através do objeto <code class="highlighter-rouge">Auth</code> temos todas as informações usuário autenticado via token, e dessa forma verificamos se o registro a ser alterado/removido pertence ao mesmo. Bem simples e funcional.</p><p>Novamente essa pode não ser a melhor forma de fazer isso, porem eu não encontrei <del>procurei pouco</del> uma forma melhor de realizar essas validações. Poderiamos como eu disse realiza-las diretamente em nossa model, mas isso vai de cada caso e nesse em especifico não julguei necessário.</p><p>Agora vamos adicionar algumas validações em nosso <code class="highlighter-rouge">JobsController</code>:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Controllers/JobsController.php
</span>
<span class="k">use</span> <span class="nx">Validator</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">JobsController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>

<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'required|max:255'</span><span class="p">,</span>
            <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
            <span class="s1">'local'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
            <span class="s1">'remote'</span> <span class="o">=&gt;</span> <span class="s1">'in:yes,no'</span><span class="p">,</span>
            <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'integer'</span><span class="p">,</span>
        <span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Validation Failed'</span><span class="p">,</span>
                <span class="s1">'errors'</span>    <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span>
            <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$job</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Job</span><span class="p">();</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">company_id</span> <span class="o">=</span> <span class="nx">\Auth</span><span class="o">::</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$job</span><span class="p">,</span> <span class="mi">201</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$job</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$job</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">\Auth</span><span class="o">::</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">!=</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">company_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'You haven\'t permission to change this entry'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'max:255'</span><span class="p">,</span>
            <span class="s1">'remote'</span> <span class="o">=&gt;</span> <span class="s1">'in:yes,no'</span><span class="p">,</span>
            <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'integer'</span><span class="p">,</span>
        <span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Validation Failed'</span><span class="p">,</span>
                <span class="s1">'errors'</span>    <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span>
            <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">());</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$job</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$job</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">\Auth</span><span class="o">::</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">!=</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">company_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'You haven\'t permission to delete this entry'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Veja que as validações são bem similares as anteriores, contudo, dessa vez adicionamos uma validação do tipo <strong>enum</strong> para <code class="highlighter-rouge">remote</code> e esperamos que o valor de <code class="highlighter-rouge">type</code> seja <strong>integer</strong>.</p><p>Perceba também que estamos adicionando o <code class="highlighter-rouge">company_id</code> baseado no id do usuário da sessão, o que facilita o relacionamento para nós e ainda adicionamos a simples validação para que apenas a empresa só possa alterar/remover seus proprios jobs.</p><h4 id="tratando-erros">Tratando erros</h4><p>Fizemos praticamente todas as validações necessárias em nossa API, entretanto faltou uma simples verificação para erros <code class="highlighter-rouge">404</code> quando um recurso não existe e <code class="highlighter-rouge">405</code> para um verbo HTTP não suportado em um determinado endpoint. Para isso vamos alterar o arquivo <code class="highlighter-rouge">Handler.php</code> que é responsável por lidar por quaisquer tipos de <strong>exception</strong> que nossa aplicação possa ter.</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Exceptions/Handler.php
</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\Exception\NotFoundHttpException</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\Exception\MethodNotAllowedHttpException</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Handler</span> <span class="k">extends</span> <span class="nx">ExceptionHandler</span>
<span class="p">{</span>
<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="o">...</span>
        <span class="c1">// Not found exception handler
</span>        <span class="k">if</span><span class="p">(</span><span class="nv">$e</span> <span class="nx">instanceof</span> <span class="nx">NotFoundHttpException</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="s1">'Invalid URI'</span><span class="p">,</span>
                    <span class="s1">'messages'</span> <span class="o">=&gt;</span> <span class="p">[]</span>
                <span class="p">]</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Method not allowed exception handler
</span>        <span class="k">if</span><span class="p">(</span><span class="nv">$e</span> <span class="nx">instanceof</span> <span class="nx">MethodNotAllowedHttpException</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="s1">'Method Not Allowed'</span><span class="p">,</span>
                    <span class="s1">'messages'</span> <span class="o">=&gt;</span> <span class="p">[]</span>
                <span class="p">]</span>
            <span class="p">],</span> <span class="mi">405</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">render</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Com as verificações <code class="highlighter-rouge">NotFoundHttpException</code> e <code class="highlighter-rouge">MethodNotAllowedHttpException</code> já resolvemos o problema, inclusive a APP já pode ser considerada pronta para produção.</p><h2 id="update">Update</h2><p>Então cadê a parte Redis? Pois é, depois de algumas horas escrevendo esta parte do artigo eu reparei que não valeria a pena adicionar <strong>redis</strong> ao projeto, já que os registros podem mudar frequentemente (ou não), mas ideia era bem simples, criar um cache para os registros, assim toda vez que os métodos <code class="highlighter-rouge">index</code> e <code class="highlighter-rouge">show</code> fossem chamados, nós iriamos buscar diretamente no cache os dados ao invés de bater no banco de dados. E toda vez que uma nova vaga/empresa fosse adicionada, atualizada ou deletada, nós atualizariamos o cache. Bem simples na verdade.</p><p>Mas como não quero demorar mais uma semana para escrever esse artigo acho válido deixar em aberto que é possível e dependendo do tamanho do seu projeto é uma boa escolha.</p></div><section class="share"><h3>Share this post</h3><ul class="social-list"><li class="social-list__item facebook hint--bottom" data-hint="Share on Facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-3/" target="share"> <span class="social-list__text">Like</span> </a></li><li class="social-list__item twitter hint--bottom" data-hint="Share on Twitter"> <a href="https://twitter.com/share?text=Construindo uma API RESTful com Laravel - Parte 3&amp;url=https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-3/" target="share"> <span class="social-list__text">Tweet</span> </a></li><li class="social-list__item gplus hint--bottom" data-hint="Share on Google Plus"> <a href="https://plus.google.com/share?url=https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-3/" target="share"> <span class="social-list__text">+1</span> </a></li></ul></section><section class="related"><h3 class="related__title">Referências</h3><ul class="default-list"><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://vimeo.com/17785736" title="Teach a Dog to REST" target="_blank"> <span itemprop="name">Teach a Dog to REST</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://github.com/tymondesigns/jwt-auth" title="Tymon/jwt-auth." target="_blank"> <span itemprop="name">Tymon/jwt-auth.</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://daylerees.com/trick-validation-within-models/" title="Trick - Validation within models." target="_blank"> <span itemprop="name">Trick - Validation within models.</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://laravel.com/docs/5.2/validation" title="Laravel - Validation" target="_blank"> <span itemprop="name">Laravel - Validation</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://www.youtube.com/playlist?list=PLpvpznviFFFJUWlHylwipLLr1iLYs-cft" title="Create REST API using Laravel" target="_blank"> <span itemprop="name">Create REST API using Laravel</span> </a></li></ul></section><div class="comments"><div id="disqus_thread"></div></div><script> if (window.location.hostname !== 'localhost') { var disqus_shortname = 'rafaelllycan'; var disqus_identifier = '/2016/construindo-restful-api-laravel-parte-3'; var disqus_config = function () { this.page.url = 'https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-3/'; this.page.identifier = '/2016/construindo-restful-api-laravel-parte-3'; }; (function() { var d = document, s = d.createElement('script'); s.src = '//' + disqus_shortname + '.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); s.async = true; (d.head || d.body).appendChild(s); })(); } </script></article><footer class="footer"><p> Made with <a href="https://jekyllrb.com/" target="_blank" class=" externalLink">Jekyll</a> and <span class="love">♥</span> by Rafaell Lycan.</p></footer></main><script async src="/assets/js/main.min.js"></script>  <script> !function(v,i,n,k,l,a){v.GoogleAnalyticsObject=n;v[n]||(v[n]=function(){ (v[n].q=v[n].q||[]).push(arguments)});v[n].l=+new Date;l=i.createElement(k); a=i.getElementsByTagName(k)[0];l.src='https://google-analytics.com/analytics.js'; a.parentNode.insertBefore(l,a)}(window,document,'ga','script'); ga('create', 'UA-16383035-5', 'auto'); ga('require', 'displayfeatures'); ga('send', 'pageview'); </script></body></html>
