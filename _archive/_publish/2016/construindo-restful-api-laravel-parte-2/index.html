<!DOCTYPE html><html lang="pt-BR" dir="ltr"><head><meta charset="utf-8"><title>Construindo uma API RESTful com Laravel - Parte 2 – Rafaell Lycan</title><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0"> <meta name="apple-mobile-web-app-capable" content="yes"><link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon"> <meta name="description" content="No artigo anterior da série nós vimos o setup básico da nossa API, mas esta na hora de fazermos mais, esta na hora de configurarmos nossas rotas e finalizar nosso CRUD. "><meta name="keywords" content="laravel, construindo apis, api restful, laravel api, laravel cors"><meta name="author" content="Rafaell Lycan - https://rafaell-lycan.com"/><meta name="reply-to" content="sonny.webdsg@gmail"/><link rel="canonical" href="https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-2/"><link rel="alternate" type="application/rss+xml" href="https://feeds.feedburner.com/rafaell-lycan" title="Rafaell Lycan RSS Feed"><link rel="dns-prefetch" href="//google-analytics.com"><link rel="dns-prefetch" href="//www.google-analytics.com"><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel='dns-prefetch' href='//s2.getsmartlook.com'><link rel='dns-prefetch' href='//rec.getsmartlook.com'><link rel="preconnect" href="//google-analytics.com" crossorigin /><link rel="preconnect" href="//www.google-analytics.com" crossorigin /><link rel="preconnect" href="//fonts.googleapis.com" crossorigin /><link rel='preconnect' href='//s2.getsmartlook.com' crossorigin><link rel='preconnect' href='//rec.getsmartlook.com' crossorigin> <meta name="google-site-verification" content="x08xUXYXTQWjHPyl9M_w5VIF07UWLSi0XUTxxCSS7rQ" /><meta name="robots" content="index, follow"><meta name="HandheldFriendly" content="True" /><meta name="MobileOptimized" content="320" /><meta name="mobile-web-app-capable" content="yes"><link rel="manifest" href="/manifest.json"><link rel="icon" sizes="192x192" href="/assets/img/icon-192x192.png"><link rel="icon" sizes="144x144" href="/assets/img/icon-144x144.png"><link rel="apple-touch-icon" sizes="128x128" href="/assets/img/icon-144x144.png"><link rel="apple-touch-icon-precomposed" sizes="128x128" href="/assets/img/icon-144x144.png"> <meta property="og:locale" content="pt_BR"><meta property="og:type" content=" article "><meta property="og:title" content="Construindo uma API RESTful com Laravel - Parte 2 – Rafaell Lycan"><meta property="og:url" content="https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-2/"><meta property="og:image" content="https://rafaell-lycan.com/assets/img/posts/laravel-api.jpg"><meta property="og:description" content="No artigo anterior da série nós vimos o setup básico da nossa API, mas esta na hora de fazermos mais, esta na hora de configurarmos nossas rotas e finalizar nosso CRUD. "><meta property="og:site_name" content="Hi there, I'm Rafaell"><meta property="article:publisher" content="https://www.facebook.com/rafaell.lycan"> <meta name="twitter:card" content="summary"><meta name="twitter:url" content="https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-2/"><meta name="twitter:title" content="Construindo uma API RESTful com Laravel - Parte 2 – Rafaell Lycan"><meta name="twitter:image" content="https://rafaell-lycan.com/assets/img/posts/laravel-api.jpg"><meta name="twitter:description" content="No artigo anterior da série nós vimos o setup básico da nossa API, mas esta na hora de fazermos mais, esta na hora de configurarmos nossas rotas e finalizar nosso CRUD. "><meta name="twitter:creator" content="@RafaellLycan"><meta property="twitter:account_id" content="50549691"> <script type="text/javascript"> if (window.location.hostname !== 'localhost') { window.smartlook||(function(d) { var o=smartlook=function(){ o.api.push(arguments)},s=d.getElementsByTagName('script')[0]; var c=d.createElement('script');o.api=new Array();c.async=true;c.type='text/javascript'; c.charset='utf-8';c.src='//rec.getsmartlook.com/bundle.js';s.parentNode.insertBefore(c,s); })(document); smartlook('init', '71b434ed5cffc14b8ccad3c50573871bcb972ef9'); } </script><link rel="stylesheet" href="/assets/css/style.css" media="all"></head><body><main class="wrap"><header class="header"><div class="container"><div class="author"> <a href="/"> <img src="/assets/img/rafaell-lycan.jpg" alt="Rafaell Lycan profile picture" title="Back to home" class="author__avatar"> </a></div><nav class="menu-list menu-list--inline"><ul class="default-list"><li class="menu-list__item"><a href="/about">About me</a></li><li class="menu-list__item"><a href="/">Blog</a></li> </ul></nav></div></header><article class="blog-post" itemscope itemtype="https://schema.org/BlogPosting"><header class="blog-post__header"><h1 class="blog-post__title" itemprop="headline">Construindo uma API RESTful com Laravel - Parte 2</h1><div class="blog-post__meta"> <span>This post is filed under</span> <a class="h6 post-tag" href="/tags#laravel">laravel</a>, <a class="h6 post-tag" href="/tags#php">php</a> <span> • Published</span> <time class="h6" datetime="2016-08-05T00:00:00+02:00" itemprop="datePublished">5 Aug 2016</time> <span> • Reading time 22 min </span></div><figure class="blog-post__banner"> <img src="/assets/img/posts/laravel-api.jpg" alt="Construindo uma API RESTful com Laravel - Parte 2" title="Construindo uma API RESTful com Laravel - Parte 2" itemprop="thumbnailUrl"></figure><p class="hidden" itemprop="keywords">laravel, construindo apis, api restful, laravel api, laravel cors</p></header><div class="blog-post__content"><p><a href="2015/construindo-restful-api-laravel-parte-1/">No artigo anterior da série</a> nós vimos o setup básico da nossa API, mas esta na hora de fazermos mais, esta na hora de configurarmos nossas rotas e a autenticação do usuário.</p><p>Depois de muito tempo e alguns pedidos para continuar a série, resolvi dar uma olhada no que faltava para terminar. Resolvi então quebrar a série em 3 partes ao invés de duas.</p><p>Nesta parte vamos tocar os seguintes tópicos do roadmap:</p><ul><li><a href="#controllers-e-rotas">Controllers e Rotas</a></li><li><a href="#middlewares">Middlewares</a></li></ul><h2 id="controllers-e-rotas">Controllers e Rotas</h2><p>Para conseguirmos expor os dados do nosso banco de dados em nossa API, precisamos seguir dois passos muito simples:</p><ol><li>Definir as rotas dos recursos utilizados em nossa aplicação, <em>Jobs</em> e <em>Companies</em>.</li><li>Criar métodos em nossos controllers que irão responder as nossas rotas para cada verbo HTTP.</li></ol><p>Todo desenvolvedor novo que começa com laravel e vê os comandos <strong>artisan</strong> e segue ao menos a documentação chega a parte de <a href="https://laravel.com/docs/5.1/routing">routing</a>, que ao meu ver é uma das partes que me fez se apaixonar pelo framework.</p><p>Vamos primeiramente definir nosso grupo de recursos em <code class="highlighter-rouge">routes.php</code>:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">group</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'prefix'</span> <span class="o">=&gt;</span> <span class="s1">'api'</span><span class="p">),</span> <span class="k">function</span><span class="p">()</span>
<span class="p">{</span>

  <span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span><span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'Jobs API'</span><span class="p">,</span> <span class="s1">'status'</span> <span class="o">=&gt;</span> <span class="s1">'Connected'</span><span class="p">]);;</span>
  <span class="p">});</span>

  <span class="nx">Route</span><span class="o">::</span><span class="na">resource</span><span class="p">(</span><span class="s1">'jobs'</span><span class="p">,</span> <span class="s1">'JobsController'</span><span class="p">);</span>
  <span class="nx">Route</span><span class="o">::</span><span class="na">resource</span><span class="p">(</span><span class="s1">'companies'</span><span class="p">,</span> <span class="s1">'CompaniesController'</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">'api'</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure><p>Primeiramente, como uma boa prática é prefixar um agrupamento de rotas que irá servir como namespace da nossa API. Nesse caso utilizamos <code class="highlighter-rouge">api</code>, porem você pode utilizar qualquer outro nome e até mesmo definir uma versão da API. Também sabemos que serão criados 2 controllers RESTful que irão lidar com o HTTP para os recursos <strong>jobs</strong> e <strong>companies</strong>. Por fim também foi adicionado um redirect caso o usuário dê um <strong>GET</strong> na raiz da aplicação.</p><p>Nosso primeiro recurso será <code class="highlighter-rouge">jobs</code> que é a base da nossa aplicação e esta relacionado ao segundo recurso <code class="highlighter-rouge">companies</code> que será o meio de gerenciar essas vagas. Pense nesse recurso como um recurso de usuário, mas ao invés de informações sobre o mesmo temos informações sobre a empresa.</p><p>Sabendo disso, vamos criar nossos recursos utilizando <strong>Artisan</strong> para gerar nossos controllers:</p><figure class="highlight"><pre><code class="language-php" data-lang="php">php artisan make:controller JobsController</code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php">php artisan make:controller CompaniesController</code></pre></figure><p>Navegando até o diretório <code class="highlighter-rouge">app/Http/Controllers</code> você vai notar que os arquivos <code class="highlighter-rouge">CompaniesController.php</code> e <code class="highlighter-rouge">JobsController.php</code> foram criados.</p><h4 id="listando-rotas">Listando rotas</h4><p>Toda vez que registramos um <strong>resource route</strong>, o Laravel adiciona e lista os endpoints que podem ser utilizados, e podemos consulta-los através do comando:</p><figure class="highlight"><pre><code class="language-php" data-lang="php">php artisan route:list</code></pre></figure><p>Isso ira nos retornar uma lista das rotas definidas seguidas pelo verbo HTTP correspondente. No fim, teremos uma listagem como essa.</p><div class="center"><p><img src="/assets/img/posts/laravel-route-list.png" alt="Laravel Route List" /></p></div><h4 id="listando-registros">Listando registros</h4><p>Até agora tudo bem, não tivemos nada muito complexo e para finalizar essa sessão de forma razoável, vamos fazer nosso <code class="highlighter-rouge">JobsController</code> retornar nossos jobs cadastrados <del>aqueles criados no seed</del> utilizando o método <code class="highlighter-rouge">index</code>:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/JobsController.php
</span><span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Job</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobsController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$jobs</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">with</span><span class="p">(</span><span class="s1">'company'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$jobs</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>O método <code class="highlighter-rouge">index</code> é normalmente utilizado para listar todos os dados do recurso, em outras palavras como um <strong>get all</strong>, e isso é exatamente o que ele esta fazendo aqui. Estamos utilizando em conjunto o <a href="https://laravel.com/docs/5.0/eloquent#eager-loading">eager loading</a> para retornar nossos <strong>jobs</strong> que estão associados com <strong>companies</strong> e só ai retornando. Também note que utilizamos nosso model <code class="highlighter-rouge">Job</code> no todo com o a declaração <code class="highlighter-rouge">use</code> para evitar o namespace toda vez que for utiliza-lo.</p><p>Para termos certeza de que esta tudo OK, podemos utilizar uma ferramente como o <a href="https://chrome.google.com/webstore/detail/postman-rest-client/fdmmgilgnpjigdojojpjoooidkmcomcm?hl=en">Postman</a> do Google Chrome que é um cliente REST para nos ajudar a testar e debugar nossas rotas da aplicação.</p><p>Uma vez que você já tenha o <strong>postman</strong> instalado, vamos realizar um request do tipo <code class="highlighter-rouge">GET</code> no endpoint <code class="highlighter-rouge">/api/jobs</code> e ver o retorno:</p><div class="center"><p><img src="/assets/img/posts/laravel-api-postman-get.png" alt="Laravel Postman GET Jobs" /></p></div><p>Já resolvemos a listagem dos jobs, agora vamos fazer o mesmo para empresas:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/CompaniesController.php
</span><span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Company</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CompaniesController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$companies</span> <span class="o">=</span> <span class="nx">Company</span><span class="o">::</span><span class="na">all</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$companies</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Aqui você pode ver que estamos fazendo exatamente a mesma coisa que em <code class="highlighter-rouge">JobsController</code> com a única diferença de trazer exclusivamente os dados de <strong>company</strong>. Você pode utilizar o <strong>postman</strong> para testar o endpoint <code class="highlighter-rouge">/api/companies</code> utilizando o verbo <code class="highlighter-rouge">GET</code>.</p><p>Já conseguimos listar nossos registros, mas algumas vezes, vamos precisar pegar apenas um passando como parâmetro no endpoint um <strong>ID</strong>, vamos fazer isso de forma simples e rápida em nossos os controllers:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/CompaniesController.php
</span><span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Company</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CompaniesController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$company</span> <span class="o">=</span> <span class="nx">Company</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$company</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$company</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/JobsController.php
</span><span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Job</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobsController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">show</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$job</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">with</span><span class="p">(</span><span class="s1">'company'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$job</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Podemos ver que é um código bem simples, primeiramente utilizando o método <code class="highlighter-rouge">find($id)</code> verificamos se o registro <code class="highlighter-rouge">$id</code> é <code class="highlighter-rouge">null</code>, se sim retornamos um <strong>erro</strong> <code class="highlighter-rouge">404</code> com uma mensagem no corpo. Caso contrário atualizamos o registro atual com os dados vindos da requisição. E pronto! Você pode testar essa implementação utilizando o verbo <code class="highlighter-rouge">GET</code> nos endpoints <code class="highlighter-rouge">/api/jobs/:id</code> e <code class="highlighter-rouge">/api/companies/:id</code> apenas subistituindo <code class="highlighter-rouge">:id</code>.</p><h4 id="criando-registros">Criando registros</h4><p>A primeira parte foi a mais fácil, agora vamos de fato criar nossas rotas para <strong>inputar registros</strong>, vamos seguir um lógica simples:</p><ul><li>Precisamos pegar dados vindo de nossas requests (<code class="highlighter-rouge">POST</code>);</li><li>Podemos também validar os dados, adicionando alguns como obrigatórios, mas iremos com isso depois;</li><li>Por fim salvar os dados utilizando o Eloquent.</li></ul><p>Eu vou começar com a empresa, por acreditar que será mais fácil por esse caminho, então vamos seguir nossa lógica utilizando o código abaixo:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/CompaniesController.php
</span><span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CompaniesController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$company</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Company</span><span class="p">();</span>
        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">());</span>
        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$company</span><span class="p">,</span> <span class="mi">201</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Esse código é ligeiramente simples, o método <code class="highlighter-rouge">store</code> recebe um objeto <code class="highlighter-rouge">Request</code> que contem todos os dados da requisição <code class="highlighter-rouge">POST</code> no endpoint <code class="highlighter-rouge">/api/companies</code> onde criamos um novo model <code class="highlighter-rouge">Company</code> que após ser salvo retornamos o mesmo com o <strong>status</strong> <code class="highlighter-rouge">201</code>.</p><p>Enviando um simples <strong>payload</strong> contendo <code class="highlighter-rouge">name</code> e <code class="highlighter-rouge">email</code> e o <strong>Content-Type</strong> como <code class="highlighter-rouge">application/json</code> já conseguimos gravar nosso primeiro registro. Vou utilizar o <strong>cURL</strong> como exemplo, mas você pode utilizar o <strong>postman</strong> se preferir:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl -H <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  -X POST -d <span class="s1">'{"name": "My awesome company","email": "contact@company.com"}'</span> <span class="se">\</span>
  https://laravel-jobs-api.dev/api/companies</code></pre></figure><p>Feito isso temos o seguinte retorno:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="s2">"name"</span><span class="err">:</span> <span class="s2">"My awesome company"</span><span class="p">,</span>
  <span class="s2">"email"</span><span class="err">:</span> <span class="s2">"contact@company.com"</span><span class="p">,</span>
  <span class="s2">"updated_at"</span><span class="err">:</span> <span class="s2">"2016-06-30 14:52:21"</span><span class="p">,</span>
  <span class="s2">"created_at"</span><span class="err">:</span> <span class="s2">"2016-06-30 14:52:21"</span><span class="p">,</span>
  <span class="s2">"id"</span><span class="err">:</span> <span class="mi">3</span>
<span class="p">}</span></code></pre></figure><p>Com o retorno da nossa empresa que possui o <code class="highlighter-rouge">id=3</code> já conseguimos criar um job que pertence a uma empresa, para isso a implementação no <code class="highlighter-rouge">JobsController</code> é tão simples quanto a que acabamos de desenvolver:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/JobsController.php
</span><span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobsController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$job</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Job</span><span class="p">();</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">());</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$job</span><span class="p">,</span> <span class="mi">201</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Com o método <code class="highlighter-rouge">store</code> implementado exatamente como vimos anteriormente, já podemos utilizar o endpoint <code class="highlighter-rouge">/api/jobs</code> com o verbo <code class="highlighter-rouge">POST</code> com o seguinte <strong>payload</strong>:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl -H <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  -X POST -d <span class="s1">'{"title": "PHP Developer / Laravel Expert","description": "Laravel Expert", "local": "São Paulo", "remote": "no", "company_id": "3"}'</span> <span class="se">\</span>
  https://laravel-jobs-api.dev/api/jobs</code></pre></figure><p>Temos o seguinte retorno:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="s2">"title"</span><span class="err">:</span> <span class="s2">"PHP Developer / Laravel Expert"</span><span class="p">,</span>
  <span class="s2">"description"</span><span class="err">:</span> <span class="s2">"Laravel Expert"</span><span class="p">,</span>
  <span class="s2">"local"</span><span class="err">:</span> <span class="s2">"São Paulo"</span><span class="p">,</span>
  <span class="s2">"remote"</span><span class="err">:</span> <span class="s2">"no"</span><span class="p">,</span>
  <span class="s2">"company_id"</span><span class="err">:</span> <span class="s2">"3"</span><span class="p">,</span>
  <span class="s2">"updated_at"</span><span class="err">:</span> <span class="s2">"2016-07-02 20:23:47"</span><span class="p">,</span>
  <span class="s2">"created_at"</span><span class="err">:</span> <span class="s2">"2016-07-02 20:23:47"</span><span class="p">,</span>
  <span class="s2">"id"</span><span class="err">:</span> <span class="mi">5</span>
<span class="p">}</span></code></pre></figure><p><em>Em bash, utilizamos o caractere <strong>barra invertida/barra inversa</strong> <code class="highlighter-rouge">\</code> para permitir quebra de linha, mas você pode enviar uma única linha apenas retirando este caractere.</em></p><p>Eu sei que nosso código esta falho, pois se não enviarmos nenhum <strong>payload</strong> o registro será criado em branco e isso não é útil para nenhuma aplicação. Vamos ver diversas <strong>armadilhas e como contorná-las</strong> com implementações simples, no caso de cadastro <em>é falho passar o</em> <code class="highlighter-rouge">id</code> <em>da empresa</em> que esta cadastrando uma vaga, esse parâmetro deve <em>ser pego na sessão</em>.</p><h4 id="atualizando-registros">Atualizando registros</h4><p>Precisamos fornecer ao usuário uma forma para atualizar os dados em nossa aplicação, nesse caso, será razoavelmente simples, porem como mencionado acima, precisamos depois <strong>lidar com as armadilhas</strong> que estamos deixando para trás, como por exemplo <em>um usuário só pode atualizar seu próprio registro de empresa e suas prórias vagas</em>. Não é uma coisa difícil de se fazer, mas precisamos saber os problemas que teremos que resolver.</p><p>Vamos adicionar uma lógica simples em nossos controllers para atualizar os registros. Vamos começar em <code class="highlighter-rouge">JobsController</code> dessa vez:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/JobsController.php
</span><span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobsController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$job</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$job</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">());</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Esse código é bem similar aos que já implementamos, verificamos se o registro <code class="highlighter-rouge">$id</code> é <code class="highlighter-rouge">null</code>, se sim retornamos um <strong>erro</strong> <code class="highlighter-rouge">404</code>, se não retornamos atualizamos o registro atual e o retornamos. Podemos agora utilizar o verbo <code class="highlighter-rouge">PUT</code> no endpoint <code class="highlighter-rouge">/api/jobs/100</code> e teremos o seguinte retorno:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="s2">"message"</span><span class="err">:</span> <span class="s2">"Record not found"</span>
<span class="p">}</span></code></pre></figure><p>Neste exemplo estamos tentando atualizar o registro de <code class="highlighter-rouge">$id=100</code>, porem o mesmo ainda não foi criado então temos a mensagem de erro acima, mas caso o mesmo exista o registro atualizado nos sera retornado com o <strong>status</strong> <code class="highlighter-rouge">200</code>.</p><p>Você provavelmente já deve ter visto também uma implementação diferente, como esta:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/JobsController.php
</span><span class="o">...</span>
<span class="k">class</span> <span class="nc">JobsController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$job</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">findOrFail</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

            <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">());</span>
            <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Illuminate\Database\Eloquent\ModelNotFoundException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$e</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Esse é o exemplo de implementação default do Laravel que você pode achar em qualquer documentação ou tutorial com o seguinte retorno:</p><figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="s2">"error"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"description"</span><span class="err">:</span> <span class="s2">"Invalid URI"</span><span class="p">,</span>
    <span class="s2">"messages"</span><span class="err">:</span> <span class="p">[]</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Eu particularmente não sou muito fã, prefiro criar uma mensagem personalizada seguindo uma outra estrutura de resposta. <strong>Mas isso é gosto, ambas implementações funcionam bem</strong>.</p><p>Agora fazendo exatamente a mesma coisa em <code class="highlighter-rouge">CompaniesController</code>:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/CompaniesController.php
</span><span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CompaniesController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$company</span> <span class="o">=</span> <span class="nx">Company</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$company</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">());</span>
        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$company</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Agora é só testar via <strong>postman</strong> ou <strong>cURL</strong> e teremos o mesmo padrão de resposta implementado em <code class="highlighter-rouge">JobsController</code>.</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl -H <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
  -X PUT -d <span class="s1">'{"name": "My new named company","email": "contact@newcompany.com"}'</span> <span class="se">\</span>
  https://laravel-jobs-api.dev/api/companies/3</code></pre></figure><p>Ja implementamos uma forma do usuário atualizar os registros, agora precisamos implementar uma forma de remove-los.</p><h4 id="deletando-registros">Deletando registros</h4><p>Essa sem dúvidas é a parte mais fácil a ser implementada, e aqui vamos deixar nossa última armadilha, por exemplo precisamos fazer a mesma validação e <em>verificar se o usuário é dono da vaga</em>, pois uma empresa só pode deletar suas próprias vagas.</p><p>O código para implementação é simplesmente ridículo, primeiro vou implementar em <code class="highlighter-rouge">CompaniesController</code> e em seguida em <code class="highlighter-rouge">JobsController</code>:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/CompaniesController.php
</span><span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">CompaniesController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$company</span> <span class="o">=</span> <span class="nx">Company</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$company</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">//app/Http/Controllers/JobsController.php
</span><span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">JobsController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$job</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$job</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Implementado o método <code class="highlighter-rouge">destroy</code>, podemos ver como o código é realmente simples. Pegamos o id passado pelo endpoint <code class="highlighter-rouge">/api/jobs/:id</code> utilizando o verbo <code class="highlighter-rouge">DELETE</code> e pronto! Caso o registro não exista retornamos um <strong>erro</strong> <code class="highlighter-rouge">404</code> com uma mensagem personalizada. Você pode utilizar <code class="highlighter-rouge">findOrFail</code> em um bloco <code class="highlighter-rouge">try/catch</code> se preferir, mas de novo, isso vai de gosto.</p><p>Podemos perceber que não existe retorno de sucesso quando um registro é deletado, você poderia utilizar o <strong>status</strong> <code class="highlighter-rouge">204</code> <em>(No Content)</em> se preferir, mas eu acredito ser apenas um contexto perdido. Prefiro deixar <code class="highlighter-rouge">200</code> como padrão.</p><p>Existe <a href="http://blog.ploeh.dk/2013/04/30/rest-lesson-learned-avoid-204-responses/">esse post</a> do <a href="https://twitter.com/ploeh">Mark Seemann</a> que eu li a mais ou menos um ano atrás, ele explica algumas <strong>lições aprendidas desenvolvendo APIs REST</strong> e que me convenceram a não utilizar <strong>status</strong> <code class="highlighter-rouge">204</code> nas respostas. Você pode simplesmente ler e tirar sua conclusão.</p><blockquote><p>A DELETE request represents the intent to delete a resource. Thus, if the service successfully handles a DELETE request, what else can it do than returning a 204 (No Content)? After all, the resource has just been removed.</p></blockquote><h2 id="middlewares">Middlewares</h2><p>Conseguimos! Fizemos o CRUD básico, contudo deixamos varios problemas para trás, alguns bem críticos na verdade.</p><p>Middlewares são recursos que nos permitem interceptar requisições HTTP. Nesse caso vamos apenas proteger algumas rotas que necessitam do usuário estar autenticado. Caso contrário nós vamos retornar um erro informando que o usuário não esta logado.</p><p>Vou tentar ser breve, não vou explicar como criar um middleware customizado mas vou explicar os conceitos básicos. Primeiramente você precisa saber que todos os middlewares existentes no Laravel, estão localizados em <code class="highlighter-rouge">/app/Http/Kernel.php</code>. Por padrão a propriedade <code class="highlighter-rouge">$routeMiddleware</code> é um <code class="highlighter-rouge">Array</code> que contem a base de middlewares do framework, e para criar e adicionar um novo middleware basta apenas incluir no array seu caminho.</p><h4 id="middlewares-em-rotas-especificas">Middlewares em rotas especificas</h4><p>É possível utilizar um middleware para proteger uma rota especifica. Por exemplo:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'admin/profile'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Protected route
</span><span class="p">})</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">);</span></code></pre></figure><p>Nesse caso estamos protegendo a rota <code class="highlighter-rouge">/admin/profile</code> com o middleware <code class="highlighter-rouge">auth</code>, que garante que o usuário precisa estar logado para acessar a determinada rota.</p><p>Também é possível utilizar mais de um middleware, onde serão validados um por um sequencialmente.</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">'admin/profile'</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Protected route
</span><span class="p">})</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">,</span> <span class="s1">'custom'</span><span class="p">);</span></code></pre></figure><p>Também é possível utiliza-los em grupos de rotas:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nx">Route</span><span class="o">::</span><span class="na">group</span><span class="p">([</span><span class="s1">'middleware'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'auth'</span><span class="p">]],</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Protected routes
</span><span class="p">});</span></code></pre></figure><p>Novamente o código é simples e irá deixar o grupo de routas protegidas com o middleware <code class="highlighter-rouge">auth</code>. Também é possível utilizar outros middlewares passando um <code class="highlighter-rouge">Array</code> como argumento.</p><h4 id="middlewares-em-controllers">Middlewares em controllers</h4><p>O conceito é o mesmo, proteger rotas especificas mas dessa vez através dos controllers. Podemos utilizar o método <code class="highlighter-rouge">$this-&gt;middleware()</code> em nosso contrutor desde que ele extenda o <code class="highlighter-rouge">Controller</code> base.</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">ApplicationController</span> <span class="k">extends</span> <span class="nx">Controller</span> <span class="p">{</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'only'</span> <span class="o">=&gt;</span> <span class="s1">'update'</span><span class="p">]);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">'custom'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'except'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'show'</span><span class="p">]]]);</span>
    <span class="p">}</span>
<span class="o">...</span>
<span class="p">}</span></code></pre></figure><p>Seguindo mais ou menos o exemplo anterior, você também pode utilizar vários middleware, sendo que eles serão usados sequencialmente. No código de exemplo o primeiro middleware de <code class="highlighter-rouge">auth</code> vai deixar todas as rotas do controller seguras, porem eu também posso informar quais rotas eu quero aplicar meu middleware através do segundo parâmetro de configuração utilizando a chave <code class="highlighter-rouge">only</code> e os métodos/rotas que o middleware será aplicado. Também é possível aplicar o middleware em todas as rotas e remover algumas entradas expecificas utilizando a chave <code class="highlighter-rouge">except</code>.</p><p>Tanto em <code class="highlighter-rouge">JobsController</code> quanto em <code class="highlighter-rouge">CompaniesController</code> vamos adicionar a seguinte configuração de middleware:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'except'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'show'</span><span class="p">]]);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Agora temos todas as rotas protegidas exceto os métodos <code class="highlighter-rouge">index</code> e <code class="highlighter-rouge">show</code> que são utilizados pelos verbo <code class="highlighter-rouge">GET</code> em ambos os controllers. Já conseguimos dar o básico de segurança em nossa aplicação, mas ainda temos muito o que fazer.</p><p>E agora vamos editar nosso middleware, apenas modificando seu comportamento padrão, e para isso vamos editar o método <code class="highlighter-rouge">handle</code> do middleware <code class="highlighter-rouge">Authenticate</code> em <code class="highlighter-rouge">/app/Http/Middleware/Authenticate.php</code>:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>

<span class="c1">// Original
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">ajax</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">(</span><span class="s1">'Unauthorized.'</span><span class="p">,</span> <span class="mi">401</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">redirect</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">guest</span><span class="p">(</span><span class="s1">'login'</span><span class="p">);</span>
    <span class="p">}</span>

<span class="c1">// Updated
</span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">auth</span><span class="o">-&gt;</span><span class="na">guest</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
            <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'Unauthorized'</span>
        <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>O que fizemos foi o seguinte, por padrão o middleware <code class="highlighter-rouge">Authenticate</code> faz dois níveis de verificação, sendo o primeiro se o usuário é convidado, ou seja se ele não esta em uma sessão. Já a segunda validação padrão é se a requisição é AJAX, se sim é retornado um <strong>erro</strong> <code class="highlighter-rouge">401</code> em texto plano, caso contrário o usuário é redirecionado para a página <code class="highlighter-rouge">/auth/login</code>.</p><p>O que fizemos foi tirar a validação das requisições e retornar uma única mensagem em formato JSON com <strong>erro</strong> <code class="highlighter-rouge">401</code>, obviamente vamos precisar tratar tokens e outras coisas mas vamos um passo por vez.</p><p>No próximo artigo vamos vamos cobrir os problemas criticos que deixamos para trás como <strong>validações de entrada</strong> para criação dos registros, criar nossa <strong>rota de autenticação</strong> que retornará um token válido, <strong>verificação e validação do token</strong> em nosso middleware de autenticação.</p><p>Peço desculpas a todos pois este artigo teve início a mais de um mês, porem como eu queria terminar tudo de uma vez, ficou faltando algumas partes, portanto vou deixar a parte restante para uma terceira e última parte da série.</p><h2 id="update">Update</h2><p>Eu já tinha começado esse artigo em julho, mas enrolei um pouco pra terminar a parte de autenticação, comecei a estudar outras coisas e esqueci completamente que faltava tão pouco pra termina-lo. Então decidi quebrar e deixar a parte de Auth para o final.</p><p>Desculpem =(</p></div><section class="share"><h3>Share this post</h3><ul class="social-list"><li class="social-list__item facebook hint--bottom" data-hint="Share on Facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-2/" target="share"> <span class="social-list__text">Like</span> </a></li><li class="social-list__item twitter hint--bottom" data-hint="Share on Twitter"> <a href="https://twitter.com/share?text=Construindo uma API RESTful com Laravel - Parte 2&amp;url=https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-2/" target="share"> <span class="social-list__text">Tweet</span> </a></li><li class="social-list__item gplus hint--bottom" data-hint="Share on Google Plus"> <a href="https://plus.google.com/share?url=https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-2/" target="share"> <span class="social-list__text">+1</span> </a></li></ul></section><section class="related"><h3 class="related__title">Referências</h3><ul class="default-list"><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://vimeo.com/17785736" title="Teach a Dog to REST" target="_blank"> <span itemprop="name">Teach a Dog to REST</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://laravel.com/docs/5.0/eloquent#eager-loading" title="Eloquent - eager-loading" target="_blank"> <span itemprop="name">Eloquent - eager-loading</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://laravel.com/docs/5.0/controllers#restful-resource-controllers" title="RESTful Resource Controllers" target="_blank"> <span itemprop="name">RESTful Resource Controllers</span> </a></li><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://laravel.com/docs/5.0/controllers#controller-middleware" title="Controller Middleware" target="_blank"> <span itemprop="name">Controller Middleware</span> </a></li></ul></section><div class="comments"><div id="disqus_thread"></div></div><script> if (window.location.hostname !== 'localhost') { var disqus_shortname = 'rafaelllycan'; var disqus_identifier = '/2016/construindo-restful-api-laravel-parte-2'; var disqus_config = function () { this.page.url = 'https://rafaell-lycan.com/2016/construindo-restful-api-laravel-parte-2/'; this.page.identifier = '/2016/construindo-restful-api-laravel-parte-2'; }; (function() { var d = document, s = d.createElement('script'); s.src = '//' + disqus_shortname + '.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); s.async = true; (d.head || d.body).appendChild(s); })(); } </script></article><footer class="footer"><p> Made with <a href="https://jekyllrb.com/" target="_blank" class=" externalLink">Jekyll</a> and <span class="love">♥</span> by Rafaell Lycan.</p></footer></main><script async src="/assets/js/main.min.js"></script>  <script> !function(v,i,n,k,l,a){v.GoogleAnalyticsObject=n;v[n]||(v[n]=function(){ (v[n].q=v[n].q||[]).push(arguments)});v[n].l=+new Date;l=i.createElement(k); a=i.getElementsByTagName(k)[0];l.src='https://google-analytics.com/analytics.js'; a.parentNode.insertBefore(l,a)}(window,document,'ga','script'); ga('create', 'UA-16383035-5', 'auto'); ga('require', 'displayfeatures'); ga('send', 'pageview'); </script></body></html>
